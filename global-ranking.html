<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨çƒæ’è¡Œæ¦œ - ä»Šå¤©è›‹ç­’ä»€ä¹ˆ</title>
    <link rel="stylesheet" href="/css/reset.css">
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/limbus-theme-v2.css">
    <link rel="stylesheet" href="/css/module/global-ranking.css">
    <link rel="stylesheet" href="/css/custom-dialog.css">
    <link rel="stylesheet" href="/css/auth-module.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Cloudflare Turnstile -->
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <script src="/js/turnstile.js"></script>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <nav class="top-nav">
        <div class="nav-brand">
            <div class="logo-icon logo-icon-ranking">
                <i class="fas fa-trophy"></i>
            </div>
            <div class="logo-text">
                <h1 data-i18n="pageTitle">å…¨çƒæ’è¡Œæ¦œ</h1>
                <span class="logo-subtitle" data-i18n="pageSubtitle">Limbus Company Â· å•é€šç«é€Ÿ</span>
            </div>
        </div>
        <div class="nav-meta">
            <div class="version-tag">
                <span class="label" data-i18n="version">ç‰ˆæœ¬</span>
                <span class="value">1.6.0</span>
            </div>
            <button class="nav-btn nav-btn-help" id="help-btn" onclick="showHelpModal()">
                <i class="fas fa-question-circle"></i>
                <span data-i18n="help">ä½¿ç”¨è¯´æ˜</span>
            </button>
            <button class="nav-btn lang-switcher" onclick="toggleLanguage()">
                <i class="fas fa-globe"></i>
                <span id="lang-label" class="lang-code">CN</span>
            </button>
            <a href="/guides" class="nav-btn nav-btn-guides" style="text-decoration:none;">
                <i class="fas fa-book-open"></i>
                <span data-i18n="guides">æ”»ç•¥ä¸­å¿ƒ</span>
            </a>
            <!-- ç”¨æˆ·ç™»å½•çŠ¶æ€æŒ‰é’® -->
            <button class="nav-btn nav-btn-auth" id="auth-btn" onclick="handleAuthClick()">
                <i class="fas fa-user"></i>
                <span id="auth-text">ç™»å½•/æ³¨å†Œ</span>
            </button>
            <a href="/" class="nav-btn nav-btn-primary" style="text-decoration:none;">
                <i class="fas fa-dice"></i>
                <span data-i18n="backHome">è¿”å›ä¸»é¡µ</span>
            </a>
        </div>
    </nav>

    <!-- ä¸»å®¹å™¨ -->
    <div class="ranking-container">
        <!-- æäº¤è®°å½•æŒ‰é’® -->
        <div class="submit-ranking-banner">
            <button id="submit-ranking-btn" class="submit-ranking-btn">
                <i class="fas fa-plus-circle"></i>
                <span data-i18n="submitRecord">æäº¤æˆ‘çš„é€šå…³è®°å½•</span>
            </button>
            <button id="check-my-records-btn" class="submit-ranking-btn" style="background: linear-gradient(135deg, #4a5568, #2d3748); margin-left: 15px;">
                <i class="fas fa-list-check"></i>
                <span data-i18n="myRecords">æŸ¥çœ‹æˆ‘çš„è®°å½•</span>
            </button>
        </div>

        <!-- ç­›é€‰é¢æ¿ -->
        <aside class="ranking-filters">
            <div class="filter-section">
                <h3 class="filter-title" data-i18n="filterSinner">ç½ªäººç­›é€‰</h3>
                <div class="filter-group" id="sinner-filters">
                    <button class="filter-btn active" data-filter-type="sinner" data-filter-value="all">
                        <i class="fas fa-th"></i> <span data-i18n="all">å…¨éƒ¨</span>
                    </button>
                    <!-- åŠ¨æ€ç”Ÿæˆç½ªäººæŒ‰é’® -->
                </div>
            </div>

            <div class="filter-section">
                <h3 class="filter-title" data-i18n="filterFloor">å±‚æ•°ç­›é€‰</h3>
                <div class="filter-group floor-filter-grid" id="floor-filters">
                    <button class="filter-btn active floor-all" data-filter-type="floor" data-filter-value="all">
                        <i class="fas fa-th"></i> <span data-i18n="allFloors">å…¨éƒ¨æ¥¼å±‚</span>
                    </button>
                    <button class="filter-btn floor-btn" data-filter-type="floor" data-filter-value="1" data-i18n="floor1">F1</button>
                    <button class="filter-btn floor-btn" data-filter-type="floor" data-filter-value="2" data-i18n="floor2">F2</button>
                    <button class="filter-btn floor-btn" data-filter-type="floor" data-filter-value="3" data-i18n="floor3">F3</button>
                    <button class="filter-btn floor-btn" data-filter-type="floor" data-filter-value="4" data-i18n="floor4">F4</button>
                    <button class="filter-btn floor-btn" data-filter-type="floor" data-filter-value="5-1" data-i18n="floor5N">F5-N</button>
                    <button class="filter-btn floor-btn" data-filter-type="floor" data-filter-value="5-2" data-i18n="floor5H">F5-H</button>
                    <button class="filter-btn floor-btn" data-filter-type="floor" data-filter-value="6" data-i18n="floor6">F6</button>
                    <button class="filter-btn floor-btn" data-filter-type="floor" data-filter-value="7" data-i18n="floor7">F7</button>
                    <button class="filter-btn floor-btn" data-filter-type="floor" data-filter-value="8" data-i18n="floor8">F8</button>
                    <button class="filter-btn floor-btn" data-filter-type="floor" data-filter-value="9" data-i18n="floor9">F9</button>
                    <button class="filter-btn floor-btn" data-filter-type="floor" data-filter-value="10" data-i18n="floor10">F10</button>
                    <button class="filter-btn floor-btn" data-filter-type="floor" data-filter-value="11" data-i18n="floor11">F11</button>
                    <button class="filter-btn floor-btn" data-filter-type="floor" data-filter-value="12" data-i18n="floor12">F12</button>
                    <button class="filter-btn floor-btn" data-filter-type="floor" data-filter-value="13" data-i18n="floor13">F13</button>
                    <button class="filter-btn floor-btn" data-filter-type="floor" data-filter-value="14" data-i18n="floor14">F14</button>
                    <button class="filter-btn floor-btn" data-filter-type="floor" data-filter-value="15" data-i18n="floor15">F15</button>
                </div>
            </div>

            <div class="filter-section">
                <h3 class="filter-title" data-i18n="sortBy">æ’åºæ–¹å¼</h3>
                <select id="sort-dropdown" class="sort-dropdown">
                    <option value="time" data-i18n="sortTime">æŒ‰é€Ÿåº¦ (æœ€å¿«)</option>
                    <option value="date" data-i18n="sortDate">æŒ‰æ—¶é—´ (æœ€æ–°)</option>
                </select>
            </div>

            <div class="filter-section">
                <button class="reset-filters-btn">
                    <i class="fas fa-undo"></i> <span data-i18n="resetFilter">é‡ç½®ç­›é€‰</span>
                </button>
            </div>

            <div class="filter-stats" id="filter-stats" style="display: none;">
                <span data-i18n="showing">æ˜¾ç¤º</span> <span id="filtered-count">0</span> <span data-i18n="records">æ¡è®°å½•</span>
            </div>
        </aside>

        <!-- æ’è¡Œæ¦œå†…å®¹ -->
        <main class="ranking-content">
            <!-- åŠ è½½çŠ¶æ€ -->
            <div id="loading-state" class="loading-state">
                <div class="spinner"></div>
                <p data-i18n="loading">æ­£åœ¨åŠ è½½æ’è¡Œæ¦œ...</p>
            </div>

            <!-- ç©ºçŠ¶æ€ -->
            <div id="empty-state" class="empty-state" style="display: none;">
                <i class="fas fa-inbox"></i>
                <p data-i18n="noRecords">æš‚æ— ç¬¦åˆæ¡ä»¶çš„è®°å½•</p>
                <p class="empty-state-hint" data-i18n="beFirst">æˆä¸ºç¬¬ä¸€ä¸ªæäº¤è®°å½•çš„äººå§ï¼</p>
            </div>

            <!-- é”™è¯¯çŠ¶æ€ -->
            <div id="error-state" class="error-state" style="display: none;">
                <i class="fas fa-exclamation-circle"></i>
                <p data-i18n="loadError">åŠ è½½æ’è¡Œæ¦œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</p>
            </div>

            <!-- æ’è¡Œæ¦œåˆ—è¡¨ -->
            <div id="ranking-list" class="ranking-list" style="display: none;">
                <!-- åŠ¨æ€ç”Ÿæˆæ’è¡Œæ¦œå¡ç‰‡ -->
            </div>

            <!-- åˆ†é¡µå™¨ -->
            <div id="pagination" class="pagination-container" style="display: none;">
                <!-- åŠ¨æ€ç”Ÿæˆåˆ†é¡µæŒ‰é’® -->
            </div>
            
            <!-- åŠ è½½æ›´å¤š -->
            <div id="load-more-container" class="load-more-container" style="display: none;">
                <button id="load-more-btn" class="load-more-btn">
                    <i class="fas fa-chevron-down"></i>
                    <span data-i18n="loadMore">åŠ è½½æ›´å¤š</span>
                </button>
            </div>
        </main>
    </div>

    <!-- é¡µè„š -->
    <footer class="ranking-page-footer">
        <div class="footer-content">
            <p data-i18n="updateInfo">æ•°æ®æ¯30åˆ†é’Ÿè‡ªåŠ¨æ›´æ–°</p>
            <p class="version-info" data-i18n="seasonInfo">ç¬¬ä¸ƒèµ›å­£ Â· æäº¤çš„è®°å½•éœ€ç®¡ç†å‘˜å®¡æ ¸åæ˜¾ç¤º</p>
            <p class="copyright-info" style="margin-top: 8px; font-size: 11px; color: var(--lc-text-muted); opacity: 0.6;">
                <span data-i18n="fanWork">æœ¬é¡¹ç›®ä¸ºç²‰ä¸ä½œå“ï¼Œä¸ Project Moon å®˜æ–¹æ— å…³</span> | <span data-i18n="dataSource">æ•°æ®æ¥æºäºç©å®¶è´¡çŒ®</span>
            </p>
        </div>
    </footer>

    <!-- å¸®åŠ©è¯´æ˜å¼¹çª— -->
    <div id="help-modal" class="modal" style="display: none;">
        <div class="modal-overlay" onclick="closeHelpModal()"></div>
        <div class="modal-content help-modal-content">
            <div class="modal-header">
                <h2 data-i18n="helpTitle">ğŸ“œ å¦‚ä½•ä½¿ç”¨æ’è¡Œæ¦œ</h2>
                <button class="modal-close" onclick="closeHelpModal()">&times;</button>
            </div>
            <div class="help-content">
                <div class="help-section">
                    <h3 data-i18n="helpView">ğŸ‘ï¸ æŸ¥çœ‹æ’è¡Œæ¦œ</h3>
                    <ul>
                        <li data-i18n="helpViewTip1">ä½¿ç”¨å·¦ä¾§ç­›é€‰é¢æ¿æŒ‰<strong>ç½ªäºº</strong>æˆ–<strong>æ¥¼å±‚</strong>ç­›é€‰è®°å½•</li>
                        <li data-i18n="helpViewTip2">æ”¯æŒæŒ‰é€šå…³é€Ÿåº¦ï¼ˆæœ€å¿«ï¼‰æˆ–æäº¤æ—¶é—´ï¼ˆæœ€æ–°ï¼‰æ’åº</li>
                        <li data-i18n="helpViewTip3">ç‚¹å‡»å¡ç‰‡å¯æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯å’ŒEGOé¥°å“é…ç½®</li>
                    </ul>
                </div>
                <div class="help-section">
                    <h3 data-i18n="helpSubmit">ğŸ”‘ æäº¤é€šå…³è®°å½•</h3>
                    <ul>
                        <li data-i18n="helpSubmitTip1">ç‚¹å‡»é¡¶éƒ¨<strong>"æäº¤æˆ‘çš„é€šå…³è®°å½•"</strong>æŒ‰é’®</li>
                        <li data-i18n="helpSubmitTip2">å¡«å†™å¿…å¡«ä¿¡æ¯ï¼šç”¨æˆ·åã€ç½ªäººã€äººæ ¼ã€é€šå…³æ—¶é—´ã€æ¥¼å±‚</li>
                        <li data-i18n="helpSubmitTip3">å¯é€‰å¡«å†™ï¼šEGOé¥°å“ã€æˆªå›¾é“¾æ¥ã€è§†é¢‘é“¾æ¥ã€å¤‡æ³¨</li>
                        <li data-i18n="helpSubmitTip4">æäº¤åéœ€ç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸ï¼Œé€šè¿‡åæ˜¾ç¤ºåœ¨æ’è¡Œæ¦œ</li>
                    </ul>
                </div>
                <div class="help-section">
                    <h3 data-i18n="helpMyRecord">ğŸ“‹ æŸ¥çœ‹æˆ‘çš„è®°å½•</h3>
                    <ul>
                        <li data-i18n="helpRecordTip1">ç‚¹å‡»<strong>"æŸ¥çœ‹æˆ‘çš„è®°å½•"</strong>æŒ‰é’®</li>
                        <li data-i18n="helpRecordTip2">è¾“å…¥æäº¤æ—¶ä½¿ç”¨çš„ç”¨æˆ·åå³å¯æŸ¥è¯¢</li>
                        <li data-i18n="helpRecordTip3">å¯æŸ¥çœ‹æ‰€æœ‰æäº¤è®°å½•çš„å®¡æ ¸çŠ¶æ€ï¼ˆå¾…å®¡æ ¸/å·²é€šè¿‡/å·²æ‹’ç»ï¼‰</li>
                    </ul>
                </div>
                <div class="help-section">
                    <h3 data-i18n="helpTips">â­ å°è´´å£«</h3>
                    <ul>
                        <li data-i18n="helpTip1">é€šå…³æ—¶é—´ä»¥ç§’ä¸ºå•ä½è®¡ç®—ï¼Œä¸»é¡µè®¡æ—¶å™¨å¯è‡ªåŠ¨è·³è½¬å¡«å……</li>
                        <li data-i18n="helpTip2">è¯·ç¡®ä¿æäº¤çš„ä¿¡æ¯çœŸå®å‡†ç¡®ï¼Œè™šå‡ä¿¡æ¯å¯èƒ½è¢«å°ç¦</li>
                        <li data-i18n="helpTip3">ç¬¬5å±‚åŒºåˆ†æ™®é€šåœ°ç‹±å’Œå›°éš¾åœ°ç‹±ä¸¤ä¸ªæ¨¡å¼</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- æäº¤è®°å½•å¼¹çª— -->
    <div id="submit-modal" class="modal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 data-i18n="submitModalTitle">æäº¤é€šå…³è®°å½•</h2>
                <button class="modal-close" id="modal-close-btn">&times;</button>
            </div>
            <form id="submit-ranking-form" class="submit-form">
                <div class="form-group">
                    <label for="username" data-i18n="labelUsername">ç”¨æˆ·å <span class="required">*</span></label>
                    <input type="text" id="username" name="username" required data-i18n-ph="phUsername" readonly style="background:var(--lc-bg-secondary);cursor:not-allowed;">
                    <small style="color:var(--lc-gold);">å·²ä½¿ç”¨ç™»å½•è´¦å·è‡ªåŠ¨å¡«å……</small>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="sinner" data-i18n="labelSinner">ç½ªäºº <span class="required">*</span></label>
                        <select id="sinner" name="sinner" required>
                            <option value="" data-i18n="selectSinner">è¯·é€‰æ‹©ç½ªäºº</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="persona" data-i18n="labelPersona">äººæ ¼ <span class="required">*</span></label>
                        <select id="persona" name="persona" required disabled>
                            <option value="" data-i18n="selectPersonaHint">è¯·å…ˆé€‰æ‹©ç½ªäºº</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="time" data-i18n="labelTime">é€šå…³æ—¶é—´ï¼ˆç§’ï¼‰ <span class="required">*</span></label>
                        <input type="number" id="time" name="time" required data-i18n-ph="phTime">
                        <small data-i18n="hintReview">ç®¡ç†å‘˜å°†è¿›è¡Œäººå·¥å®¡æ ¸</small>
                    </div>
                    <div class="form-group">
                        <label for="floorLevel" data-i18n="labelFloor">é€šå…³æ¥¼å±‚ <span class="required">*</span></label>
                        <select id="floorLevel" name="floorLevel" required>
                            <option value="" data-i18n="selectFloor">è¯·é€‰æ‹©æ¥¼å±‚</option>
                            <option value="1">ç¬¬1å±‚</option>
                            <option value="2">ç¬¬2å±‚</option>
                            <option value="3">ç¬¬3å±‚</option>
                            <option value="4">ç¬¬4å±‚</option>
                            <option value="5-1">ç¬¬5å±‚ - æ™®ç‰¢</option>
                            <option value="5-2">ç¬¬5å±‚ - å›°ç‰¢</option>
                            <option value="6">ç¬¬6å±‚</option>
                            <option value="7">ç¬¬7å±‚</option>
                            <option value="8">ç¬¬8å±‚</option>
                            <option value="9">ç¬¬9å±‚</option>
                            <option value="10">ç¬¬10å±‚</option>
                            <option value="11">ç¬¬11å±‚</option>
                            <option value="12">ç¬¬12å±‚</option>
                            <option value="13">ç¬¬13å±‚</option>
                            <option value="14">ç¬¬14å±‚</option>
                            <option value="15">ç¬¬15å±‚</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="egoGifts" data-i18n="labelEgo">EGOé¥°å“é…ç½®</label>
                    <textarea id="egoGifts" name="egoGifts" rows="2" data-i18n-ph="phEgo"></textarea>
                </div>

                <div class="form-group">
                    <label>æˆªå›¾è¯æ˜ <span style="color:var(--lc-text-muted);font-weight:400;">(ä¸Šä¼ é€šå…³æˆªå›¾æˆ–å¤–é“¾)</span></label>
                    
                    <!-- å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ -->
                    <div id="ranking-screenshot-upload" style="border:2px dashed rgba(201,169,97,0.3);border-radius:8px;padding:16px;text-align:center;background:rgba(0,0,0,0.2);cursor:pointer;margin-bottom:10px;transition:all 0.3s;"
                         ondragover="event.preventDefault();this.style.borderColor='var(--lc-gold)';this.style.background='rgba(201,169,97,0.05)';" 
                         ondragleave="this.style.borderColor='rgba(201,169,97,0.3)';this.style.background='rgba(0,0,0,0.2)';"
                         onclick="document.getElementById('ranking-screenshot-file').click()">
                        <span id="ranking-screenshot-icon" style="font-size:24px;display:block;margin-bottom:6px;">ğŸ“·</span>
                        <div id="ranking-screenshot-text" style="color:var(--lc-text-secondary);font-size:0.85rem;">ç‚¹å‡»æˆ–æ‹–æ‹½æˆªå›¾åˆ°æ­¤å¤„ä¸Šä¼ </div>
                        <div style="color:var(--lc-text-muted);font-size:0.75rem;margin-top:4px;">æ”¯æŒ JPG, PNG æ ¼å¼ï¼Œæœ€å¤§ 10MB</div>
                        <input type="file" id="ranking-screenshot-file" accept="image/*" style="display:none;" onchange="handleRankingScreenshotUpload(event)">
                    </div>
                    
                    <!-- ä¸Šä¼ è¿›åº¦ -->
                    <div id="ranking-upload-progress" style="display:none;margin-bottom:10px;">
                        <div style="display:flex;align-items:center;gap:10px;margin-bottom:4px;">
                            <span style="font-size:0.8rem;color:var(--lc-gold);">ä¸Šä¼ ä¸­...</span>
                            <span id="ranking-upload-percent" style="font-size:0.8rem;color:var(--lc-text);font-weight:600;">0%</span>
                        </div>
                        <div style="height:3px;background:rgba(255,255,255,0.1);border-radius:2px;overflow:hidden;">
                            <div id="ranking-progress-bar" style="height:100%;width:0%;background:linear-gradient(90deg,var(--lc-gold),#b8942d);transition:width 0.3s;"></div>
                        </div>
                    </div>
                    
                    <!-- é¢„è§ˆåŒºåŸŸ -->
                    <div id="ranking-screenshot-preview" style="display:none;margin-bottom:10px;position:relative;">
                        <img id="ranking-preview-img" src="" style="width:100%;max-height:150px;object-fit:cover;border-radius:6px;border:1px solid rgba(201,169,97,0.3);">
                        <button type="button" onclick="removeRankingScreenshot(event)" style="position:absolute;top:6px;right:6px;width:26px;height:26px;background:rgba(201,79,79,0.9);border:none;border-radius:50%;color:#fff;cursor:pointer;font-size:12px;" title="åˆ é™¤å›¾ç‰‡">âœ•</button>
                    </div>
                    
                    <input type="hidden" id="ranking-screenshot-value" name="screenshotUrl">
                    
                    <input type="url" id="screenshotUrl" name="screenshotUrl" placeholder="æˆ–è€…ç²˜è´´å¤–éƒ¨å›¾ç‰‡é“¾æ¥ (https://...)" 
                           style="width:100%;padding:10px 12px;background:var(--lc-bg-secondary);border:1px solid var(--lc-border);border-radius:6px;color:var(--lc-text);box-sizing:border-box;">
                </div>

                <div class="form-group">
                    <label for="videoUrl" data-i18n="labelVideo">è§†é¢‘é“¾æ¥</label>
                    <input type="url" id="videoUrl" name="videoUrl" data-i18n-ph="phVideo">
                </div>

                <div class="form-group">
                    <label for="notes" data-i18n="labelNotes">å¤‡æ³¨è¯´æ˜</label>
                    <textarea id="notes" name="notes" rows="3" data-i18n-ph="phNotes"></textarea>
                </div>

                <!-- åŒæ­¥æäº¤æ”»ç•¥é€‰é¡¹ -->
                <div class="form-group" style="background:rgba(201,169,97,0.05);border:1px solid rgba(201,169,97,0.2);border-radius:8px;padding:12px;margin-top:15px;">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin:0;">
                        <input type="checkbox" id="sync-guide-check" style="width:18px;height:18px;cursor:pointer;">
                        <span style="color:var(--lc-gold);font-weight:600;">åŒæ­¥æäº¤ä¸ºæ”»ç•¥</span>
                    </label>
                    <p style="margin:6px 0 0 26px;color:var(--lc-text-muted);font-size:0.8rem;">
                        æäº¤åå°†è·³è½¬åˆ°æ”»ç•¥é¡µé¢ï¼Œå¡«å†™è¯¦ç»†æ”»ç•¥å†…å®¹åå‘å¸ƒ
                    </p>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-cancel" id="cancel-btn" data-i18n="btnCancel">å–æ¶ˆ</button>
                    <button type="submit" class="btn-submit" data-i18n="btnSubmit">æäº¤è®°å½•</button>
                </div>
            </form>
        </div>
    </div>

    <!-- æŸ¥çœ‹æˆ‘çš„è®°å½•æ¨¡æ€æ¡† -->
    <div id="my-records-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 data-i18n="myRecordsTitle">æˆ‘çš„æäº¤è®°å½•</h2>
                <button class="modal-close" id="my-records-close-btn">&times;</button>
            </div>
            
            <div id="username-input-section" style="padding: 20px;">
                <div class="form-group">
                    <label for="query-username" data-i18n="queryUsername">è¯·è¾“å…¥æ‚¨çš„ç”¨æˆ·å</label>
                    <input type="text" id="query-username" data-i18n-ph="queryPlaceholder" style="width: 100%; padding: 10px; border: 1px solid var(--lc-border); background: var(--lc-bg-secondary); color: var(--lc-text); border-radius: 4px;">
                </div>
                <button id="query-records-btn" class="btn-submit" style="width: 100%; margin-top: 10px;">
                    <i class="fas fa-search"></i> <span data-i18n="queryBtn">æŸ¥è¯¢è®°å½•</span>
                </button>
            </div>

            <div id="my-records-content" style="display: none; padding: 20px;">
                <div id="records-stats" style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 150px; background: var(--lc-bg-card); padding: 15px; border-radius: 6px; border: 1px solid var(--lc-border);">
                        <div style="color: var(--lc-text-muted); font-size: 0.8rem; margin-bottom: 5px;" data-i18n="totalLabel">æ€»è®°å½•æ•°</div>
                        <div id="total-count" style="color: var(--lc-gold); font-size: 1.5rem; font-weight: bold;">0</div>
                    </div>
                    <div style="flex: 1; min-width: 150px; background: var(--lc-bg-card); padding: 15px; border-radius: 6px; border: 1px solid rgba(255, 193, 7, 0.3);">
                        <div style="color: var(--lc-text-muted); font-size: 0.8rem; margin-bottom: 5px;" data-i18n="pendingLabel">å¾…å®¡æ ¸</div>
                        <div id="pending-count" style="color: #ffc107; font-size: 1.5rem; font-weight: bold;">0</div>
                    </div>
                    <div style="flex: 1; min-width: 150px; background: var(--lc-bg-card); padding: 15px; border-radius: 6px; border: 1px solid rgba(76, 175, 80, 0.3);">
                        <div style="color: var(--lc-text-muted); font-size: 0.8rem; margin-bottom: 5px;" data-i18n="approvedLabel">å·²é€šè¿‡</div>
                        <div id="approved-count" style="color: #4caf50; font-size: 1.5rem; font-weight: bold;">0</div>
                    </div>
                    <div style="flex: 1; min-width: 150px; background: var(--lc-bg-card); padding: 15px; border-radius: 6px; border: 1px solid rgba(244, 67, 54, 0.3);">
                        <div style="color: var(--lc-text-muted); font-size: 0.8rem; margin-bottom: 5px;" data-i18n="rejectedLabel">å·²æ‹’ç»</div>
                        <div id="rejected-count" style="color: #f44336; font-size: 1.5rem; font-weight: bold;">0</div>
                    </div>
                </div>

                <div id="records-list" style="max-height: 500px; overflow-y: auto;"></div>
            </div>

            <div id="no-records-message" style="display: none; padding: 40px; text-align: center; color: var(--lc-text-muted);">
                <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                <p data-i18n="noRecordsFound">æœªæ‰¾åˆ°ç›¸å…³è®°å½•</p>
            </div>
        </div>
    </div>

    <!-- è„šæœ¬ -->
    <!-- API é…ç½® -->
    <script src="/js/config.js"></script>
    <script src="/js/custom-dialog.js"></script>
    <script src="/js/i18n/zh.js"></script>
    <script src="/js/i18n/en.js"></script>
    <script src="/js/i18n.js"></script>
    <script type="module">
        import { globalRankingController } from '/js/controllers/globalRankingController.js';
        import { sinnerData } from '/data/characters.js';
        import { logger } from '/js/core/logger.js';

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                logger.info('[Global Ranking] é¡µé¢åˆå§‹åŒ–å¼€å§‹');

                // â­ ç¬¬ä¸€æ­¥ï¼šåˆå§‹åŒ–è¯­è¨€ç®¡ç†å™¨ï¼ˆå¿…é¡»å…ˆåšè¿™ä¸ªï¼‰
                await I18nManager.init();
                logger.info('[Global Ranking] è¯­è¨€åˆå§‹åŒ–å®Œæˆï¼Œå½“å‰è¯­è¨€: ' + I18nManager.currentLang);

                // ç”Ÿæˆç½ªäººç­›é€‰æŒ‰é’®
                const sinnerFilters = document.getElementById('sinner-filters');
                if (sinnerFilters && sinnerData) {
                    // ä¿ç•™"å…¨éƒ¨"æŒ‰é’®ï¼Œç„¶åæ·»åŠ ç½ªäººæŒ‰é’®
                    const allButton = sinnerFilters.querySelector('[data-filter-value="all"]');
                    sinnerFilters.innerHTML = (allButton ? allButton.outerHTML : '') + 
                        sinnerData.map(sinner => {
                            // æå–è‹±æ–‡åï¼ˆæ‹¬å·å†…çš„éƒ¨åˆ†ï¼‰
                            const enMatch = sinner.name.match(/\(([^)]+)\)/);
                            const enName = enMatch ? enMatch[1] : sinner.name.split(' ')[0];
                            // ä½¿ç”¨ I18nManager çš„æ˜ å°„è·å–æ˜¾ç¤ºåç§°
                            const displayName = I18nManager.getSinnerName(enName);
                            return `
                            <button class="filter-btn sinner-filter-btn" data-filter-type="sinner" data-filter-value="${sinner.name}" data-en="${enName}">
                                ${displayName}
                            </button>
                        `}).join('');
                }

                // åˆå§‹åŒ–Controller
                globalRankingController.initDOM({
                    container: document.querySelector('.ranking-container'),
                    list: document.getElementById('ranking-list'),
                    pagination: document.getElementById('pagination'),
                    filterBtns: document.querySelectorAll('.filter-btn'), // åœ¨æŒ‰é’®ç”Ÿæˆåå†è·å–
                    sortDropdown: document.getElementById('sort-dropdown'),
                    loading: document.getElementById('loading-state'),
                    empty: document.getElementById('empty-state'),
                    error: document.getElementById('error-state')
                });

                // é‡ç½®æŒ‰é’®äº‹ä»¶
                document.querySelector('.reset-filters-btn').addEventListener('click', () => {
                    globalRankingController.setFilters({
                        sinner: null,
                        floorLevel: null,
                        sortBy: 'time'
                    });
                    document.querySelectorAll('.filter-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    globalRankingController.loadRankings();
                });

                // åŠ è½½åˆå§‹æ•°æ®
                await globalRankingController.loadRankings();

                // å¯ç”¨å®æ—¶æ›´æ–°ï¼ˆ30åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡ï¼‰
                globalRankingController.startWatchingUpdates(1800000);

                logger.info('[Global Ranking] é¡µé¢åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                logger.error('[Global Ranking] åˆå§‹åŒ–å¤±è´¥:', error);
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('error-state').style.display = 'block';
            }
        });

        // é¡µé¢å¸è½½æ—¶åœæ­¢æ›´æ–°
        window.addEventListener('beforeunload', () => {
            if (globalRankingController && globalRankingController.stopWatchingUpdates) {
                globalRankingController.stopWatchingUpdates();
            }
        });
    </script>

    <script type="module">
        import { sinnerData } from '/data/characters.js';
        import { cloudbaseAPI } from '/js/api/cloudbaseApi.js';
        import { AuthModule } from '/js/modules/authModule.js';

        // ç”¨æˆ·ç™»å½•çŠ¶æ€
        let currentUser = null;

        // æ›´æ–°ç”¨æˆ·ç™»å½•çŠ¶æ€UI
        function updateUserUI(user) {
            const authBtn = document.getElementById('auth-btn');
            const authText = document.getElementById('auth-text');
            
            // é˜²å¾¡æ€§æ£€æŸ¥
            if (!authBtn || !authText) {
                console.error('[Global Ranking] è®¤è¯æŒ‰é’®å…ƒç´ æœªæ‰¾åˆ°');
                return;
            }
            
            currentUser = user;
            
            if (currentUser && currentUser.username) {
                // æ›´æ–°ä¸ºç™»å½•çŠ¶æ€
                authText.textContent = currentUser.username;
                authBtn.classList.add('logged-in');
                authBtn.title = 'ç‚¹å‡»ç™»å‡º';
                // åŒæ­¥è®¾ç½® cloudbaseAPI çš„ token
                cloudbaseAPI.setToken(currentUser.token);
                console.log('[Global Ranking] ç™»å½•çŠ¶æ€å·²æ›´æ–°:', currentUser.username);
            } else {
                // æ›´æ–°ä¸ºæœªç™»å½•çŠ¶æ€
                authText.textContent = 'ç™»å½•/æ³¨å†Œ';
                authBtn.classList.remove('logged-in');
                authBtn.title = 'ç‚¹å‡»ç™»å½•/æ³¨å†Œ';
                // æ¸…é™¤ cloudbaseAPI çš„ token
                cloudbaseAPI.setToken(null);
                console.log('[Global Ranking] å·²åˆ‡æ¢ä¸ºæœªç™»å½•çŠ¶æ€');
            }
        }

        // åˆå§‹åŒ–è®¤è¯æ¨¡å—
        AuthModule.init({
            onUserChange: updateUserUI,
            showMessage: (msg, type) => {
                if (type === 'success') showSuccess(msg);
                else if (type === 'error') showError(msg);
                else showError(msg); // warningä¹Ÿç”¨erroræ˜¾ç¤º
            }
        });

        // ä» AuthModule è·å–å½“å‰ç”¨æˆ·
        currentUser = AuthModule.getUser();

        // ç›‘å¬ storage äº‹ä»¶ï¼Œå®ç°å¤šé¡µé¢ç™»å½•çŠ¶æ€åŒæ­¥
        window.addEventListener('storage', (e) => {
            if (e.key === 'limbus_user') {
                const newUser = e.newValue ? JSON.parse(e.newValue) : null;
                updateUserUI(newUser);
                // æ›´æ–° AuthModule å†…éƒ¨çŠ¶æ€
                if (newUser) {
                    AuthModule.currentUser = newUser;
                } else {
                    AuthModule.currentUser = null;
                }
            }
        });
        
        // åˆå§‹åŒ–æ—¶ç«‹å³æ›´æ–°ä¸€æ¬¡UIï¼ˆç¡®ä¿é¡µé¢åˆ·æ–°åæ­£ç¡®æ˜¾ç¤ºç™»å½•çŠ¶æ€ï¼‰
        updateUserUI(currentUser);

        // å¤„ç†ç™»å½•æŒ‰é’®ç‚¹å‡» - ä½¿ç”¨AuthModule
        window.handleAuthClick = function() {
            AuthModule.openAuthModal();
        };

        // æ‰“å¼€ç™»å½•æç¤ºå¼¹çª—ï¼ˆéœ€è¦ç™»å½•æ—¶æ˜¾ç¤ºï¼‰
        function showLoginRequired() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay login-required-modal';
            modal.style.cssText = 'display:flex;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:9999;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:var(--lc-bg-card);border:1px solid var(--lc-border);border-radius:12px;padding:30px;max-width:400px;text-align:center;">
                    <i class="fas fa-user-lock" style="font-size:3rem;color:var(--lc-gold);margin-bottom:15px;"></i>
                    <h3 style="color:var(--lc-text);margin-bottom:10px;">éœ€è¦ç™»å½•</h3>
                    <p style="color:var(--lc-text-muted);margin-bottom:20px;">è¯·å…ˆç™»å½•åå†æäº¤é€šå…³è®°å½•</p>
                    <div style="display:flex;gap:10px;justify-content:center;">
                        <button onclick="this.closest('.login-required-modal').remove()" style="padding:10px 20px;background:var(--lc-bg-secondary);border:1px solid var(--lc-border);border-radius:6px;color:var(--lc-text);cursor:pointer;">å–æ¶ˆ</button>
                        <button onclick="this.closest('.login-required-modal').remove(); AuthModule.openAuthModal();" style="padding:10px 20px;background:linear-gradient(135deg,var(--lc-gold),var(--lc-gold-dark));border:none;border-radius:6px;color:#1a1a2e;cursor:pointer;font-weight:600;">ç™»å½•/æ³¨å†Œ</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // ä¿®å¤ï¼šä½¿ç”¨ mousedown/mouseup ç»„åˆåˆ¤æ–­ç‚¹å‡»å¤–éƒ¨
            let isMouseDownOnOverlay = false;
            
            modal.addEventListener('mousedown', (e) => {
                isMouseDownOnOverlay = (e.target === modal);
            });
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal && isMouseDownOnOverlay) {
                    modal.remove();
                }
                isMouseDownOnOverlay = false;
            });
        }

        // æäº¤è®°å½•æŒ‰é’® - æ·»åŠ ç™»å½•éªŒè¯
        document.getElementById('submit-ranking-btn').addEventListener('click', () => {
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            currentUser = AuthModule.getUser();
            if (!currentUser) {
                showLoginRequired();
                return;
            }
            // è‡ªåŠ¨å¡«å……ç”¨æˆ·å
            document.getElementById('username').value = currentUser.username;
            document.getElementById('submit-modal').style.display = 'flex';
        });

        // å…³é—­å¼¹çª—
        const closeModal = () => {
            document.getElementById('submit-modal').style.display = 'none';
            document.getElementById('submit-ranking-form').reset();
            document.getElementById('persona').disabled = true;
            document.getElementById('persona').innerHTML = '<option value="">' + I18nManager.t('selectPersonaHint') + '</option>';
        };

        document.getElementById('modal-close-btn').addEventListener('click', closeModal);
        document.getElementById('cancel-btn').addEventListener('click', closeModal);
        
        // ä¿®å¤ï¼šç‚¹å‡»å¤–éƒ¨å…³é—­å¼¹çª—æ—¶ï¼Œé¿å…æ–‡æœ¬é€‰æ‹©æ—¶æ„å¤–è§¦å‘
        const submitModalOverlay = document.querySelector('#submit-modal .modal-overlay');
        if (submitModalOverlay) {
            let isMouseDownOnOverlay = false;
            
            submitModalOverlay.addEventListener('mousedown', (e) => {
                isMouseDownOnOverlay = (e.target === submitModalOverlay);
            });
            
            submitModalOverlay.addEventListener('click', (e) => {
                if (e.target === submitModalOverlay && isMouseDownOnOverlay) {
                    closeModal();
                }
                isMouseDownOnOverlay = false;
            });
        }

        // å¡«å……è¡¨å•é€‰é¡¹
        const sinnerSelect = document.getElementById('sinner');
        if (sinnerData && sinnerSelect) {
            sinnerData.forEach(sinner => {
                const option = document.createElement('option');
                option.value = sinner.name;
                option.textContent = sinner.name;
                sinnerSelect.appendChild(option);
            });
        }

        // ç½ªäººé€‰æ‹©å˜åŒ–æ—¶æ›´æ–°äººæ ¼åˆ—è¡¨
        sinnerSelect.addEventListener('change', (e) => {
            const personaSelect = document.getElementById('persona');
            personaSelect.innerHTML = '<option value="">' + I18nManager.t('selectPersona') + '</option>';
            personaSelect.disabled = false;
            
            const selectedSinnerName = e.target.value;
            const selectedSinner = sinnerData.find(s => s.name === selectedSinnerName);
            
            if (selectedSinner && selectedSinner.personalities) {
                selectedSinner.personalities.forEach(persona => {
                    const option = document.createElement('option');
                    option.value = persona.name;
                    option.textContent = persona.name;
                    personaSelect.appendChild(option);
                });
            } else {
                personaSelect.disabled = true;
            }
        });

        // å¤„ç† URL å‚æ•°ï¼ˆä»è®¡æ—¶å™¨è·³è½¬è¿‡æ¥ï¼‰
        function handleUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const time = urlParams.get('time');
            const sinner = urlParams.get('sinner');
            const persona = urlParams.get('persona');

            if (time) {
                // è‡ªåŠ¨æ‰“å¼€æäº¤å¼¹çª—
                document.getElementById('submit-modal').style.display = 'flex';
                
                // å¡«å……æ—¶é—´
                document.getElementById('time').value = time;
                
                // å¡«å……ç½ªäºº
                if (sinner) {
                    const sinnerSelect = document.getElementById('sinner');
                    // ç²¾ç¡®åŒ¹é…ï¼šæ£€æŸ¥ç½ªäººåç§°æ˜¯å¦åŒ…å«åœ¨é€‰é¡¹å€¼ä¸­
                    let selectedOption = null;
                    for (let option of sinnerSelect.options) {
                        // ä¾‹å¦‚ï¼šsinner="æç®±" åº”è¯¥åŒ¹é… option.value="æç®± (Yi Sang)"
                        if (option.value.startsWith(sinner)) {
                            selectedOption = option;
                            break;
                        }
                    }
                    
                    if (selectedOption) {
                        sinnerSelect.value = selectedOption.value;
                        // è§¦å‘ change äº‹ä»¶æ¥åŠ è½½äººæ ¼åˆ—è¡¨
                        sinnerSelect.dispatchEvent(new Event('change'));
                        
                        // å¡«å……äººæ ¼ï¼ˆéœ€è¦ç­‰äººæ ¼åˆ—è¡¨åŠ è½½ï¼‰
                        if (persona) {
                            setTimeout(() => {
                                const personaSelect = document.getElementById('persona');
                                // ç²¾ç¡®åŒ¹é…äººæ ¼åç§°
                                for (let pOption of personaSelect.options) {
                                    if (pOption.value === persona) {
                                        personaSelect.value = pOption.value;
                                        break;
                                    }
                                }
                            }, 100);
                        }
                    }
                }
            }
        }

        // é¡µé¢åŠ è½½æ—¶å¤„ç† URL å‚æ•°
        handleUrlParams();

        // ==================== æˆªå›¾ä¸Šä¼ åŠŸèƒ½ï¼ˆä½¿ç”¨åç«¯ä»£ç†ä¸Šä¼ åˆ°COSï¼‰====================
        // ä½¿ç”¨å…¨å±€ API_BASE æˆ–å›é€€åˆ°ç›¸å¯¹è·¯å¾„
        const API_BASE = window.API_BASE || '/api';
        
        window.handleRankingScreenshotUpload = async function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // éªŒè¯æ–‡ä»¶ç±»å‹
            if (!file.type.startsWith('image/')) {
                showError('è¯·ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶');
                return;
            }
            
            // éªŒè¯æ–‡ä»¶å¤§å° (10MB)
            if (file.size > 10 * 1024 * 1024) {
                showError('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡10MB');
                return;
            }
            
            const uploadArea = document.getElementById('ranking-screenshot-upload');
            const progressArea = document.getElementById('ranking-upload-progress');
            const percentEl = document.getElementById('ranking-upload-percent');
            const progressBar = document.getElementById('ranking-progress-bar');
            const previewArea = document.getElementById('ranking-screenshot-preview');
            const previewImg = document.getElementById('ranking-preview-img');
            const hiddenInput = document.getElementById('ranking-screenshot-value');
            
            // æ˜¾ç¤ºè¿›åº¦æ¡
            uploadArea.style.display = 'none';
            progressArea.style.display = 'block';
            percentEl.textContent = '0%';
            progressBar.style.width = '0%';
            
            try {
                const formData = new FormData();
                formData.append('image', file);
                
                // æ¨¡æ‹Ÿè¿›åº¦
                let progress = 0;
                const progressInterval = setInterval(() => {
                    if (progress < 90) {
                        progress += Math.random() * 10;
                        const percent = Math.min(Math.round(progress), 90);
                        percentEl.textContent = percent + '%';
                        progressBar.style.width = percent + '%';
                    }
                }, 200);
                
                const response = await fetch(`${API_BASE}/upload/image`, {
                    method: 'POST',
                    body: formData
                });
                
                clearInterval(progressInterval);
                
                const result = await response.json();
                
                if (result.code === 200 && result.success) {
                    percentEl.textContent = '100%';
                    progressBar.style.width = '100%';
                    
                    // æ˜¾ç¤ºé¢„è§ˆ
                    previewImg.src = result.data.url;
                    previewArea.style.display = 'block';
                    progressArea.style.display = 'none';
                    
                    // ä¿å­˜URLåˆ°éšè—å­—æ®µå’Œè¾“å…¥æ¡†
                    hiddenInput.value = result.data.url;
                    document.getElementById('screenshotUrl').value = result.data.url;
                    
                    showSuccess('æˆªå›¾ä¸Šä¼ æˆåŠŸï¼');
                } else {
                    throw new Error(result.message || 'ä¸Šä¼ å¤±è´¥');
                }
            } catch (error) {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                uploadArea.style.display = 'block';
                progressArea.style.display = 'none';
                showError('ä¸Šä¼ å¤±è´¥: ' + (error.message || 'è¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•'));
            }
        };
        
        window.removeRankingScreenshot = function(event) {
            event.stopPropagation();
            
            document.getElementById('ranking-screenshot-upload').style.display = 'block';
            document.getElementById('ranking-screenshot-preview').style.display = 'none';
            document.getElementById('ranking-upload-progress').style.display = 'none';
            document.getElementById('ranking-screenshot-value').value = '';
            document.getElementById('screenshotUrl').value = '';
            document.getElementById('ranking-screenshot-file').value = '';
        };

        // æäº¤è¡¨å•
        document.getElementById('submit-ranking-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // å†æ¬¡æ£€æŸ¥ç™»å½•çŠ¶æ€
            currentUser = AuthModule.getUser();
            if (!currentUser) {
                showLoginRequired();
                return;
            }
            
            const formData = new FormData(e.target);
            const data = {
                username: formData.get('username'),
                sinner: formData.get('sinner'),
                persona: formData.get('persona'),
                time: parseInt(formData.get('time')),
                floorLevel: formData.get('floorLevel'), // ä¿æŒå­—ç¬¦ä¸²ï¼Œæ”¯æŒ "5-1", "5-2"
                egoGifts: formData.get('egoGifts') ? formData.get('egoGifts').split(/[,ï¼Œã€\n]/).map(s => s.trim()).filter(Boolean) : [],
                screenshotUrl: formData.get('screenshotUrl') || null,
                videoUrl: formData.get('videoUrl') || null,
                notes: formData.get('notes') || null
            };

            // æ£€æŸ¥æ˜¯å¦å‹¾é€‰äº†åŒæ­¥æäº¤æ”»ç•¥
            const syncGuide = document.getElementById('sync-guide-check').checked;

            try {
                const loading = showLoading(I18nManager.t('submitting'));
                await cloudbaseAPI.submitRanking(data);
                
                // ä¿å­˜æäº¤æ•°æ®åˆ° localStorageï¼Œä¾›æ”»ç•¥è¡¨å•è‡ªåŠ¨å¡«å……ä½¿ç”¨
                localStorage.setItem('last_ranking_submission', JSON.stringify({
                    ...data,
                    submittedAt: new Date().toISOString()
                }));
                
                loading.close();
                
                // å¦‚æœå‹¾é€‰äº†åŒæ­¥æäº¤æ”»ç•¥ï¼Œè·³è½¬åˆ°æ”»ç•¥é¡µé¢è®©ç”¨æˆ·å¡«å†™è¯¦ç»†å†…å®¹
                if (syncGuide) {
                    // æ ‡è®°éœ€è¦æ‰“å¼€æ”»ç•¥æäº¤è¡¨å•
                    localStorage.setItem('open_guide_submit', 'true');
                    showSuccess('æ’è¡Œæ¦œè®°å½•æäº¤æˆåŠŸï¼å³å°†è·³è½¬åˆ°æ”»ç•¥æäº¤é¡µé¢...', 2000);
                    // å»¶è¿Ÿè·³è½¬ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æˆåŠŸæç¤º
                    setTimeout(() => {
                        closeModal();
                        window.location.href = '/guides';
                    }, 1500);
                } else {
                    showSuccess(I18nManager.t('submitSuccess'), 2000);
                    setTimeout(() => {
                        closeModal();
                        window.location.reload();
                    }, 1500);
                }
            } catch (error) {
                showError(I18nManager.t('submitError') + error.message);
            }
        });

        // æŸ¥çœ‹æˆ‘çš„è®°å½•åŠŸèƒ½ - éœ€è¦ç™»å½•
        document.getElementById('check-my-records-btn').addEventListener('click', async () => {
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            currentUser = AuthModule.getUser();
            if (!currentUser) {
                showLoginRequired();
                return;
            }
            
            // ç›´æ¥ä½¿ç”¨ç™»å½•ç”¨æˆ·çš„ç”¨æˆ·åæŸ¥è¯¢
            document.getElementById('my-records-modal').style.display = 'flex';
            document.getElementById('username-input-section').style.display = 'none';
            document.getElementById('my-records-content').style.display = 'none';
            document.getElementById('no-records-message').style.display = 'none';
            
            const loading = showLoading(I18nManager.t('searching'));
            try {
                // ä½¿ç”¨ç”¨æˆ· token è¿›è¡Œè®¤è¯çš„è¯·æ±‚
                const response = await fetch(`${API_BASE}/rankings/my-records?username=${encodeURIComponent(currentUser.username)}`, {
                    headers: {
                        ...(currentUser.token && { 'Authorization': `Bearer ${currentUser.token}` })
                    }
                });
                const result = await response.json();
                loading.close();

                if (result.code === 200 && result.data.records.length > 0) {
                    displayMyRecords(result.data);
                } else {
                    document.getElementById('no-records-message').style.display = 'block';
                }
            } catch (error) {
                loading.close();
                showError(I18nManager.t('searchError') + error.message);
            }
        });

        // å…³é—­æŒ‰é’®
        document.getElementById('my-records-close-btn').addEventListener('click', () => {
            document.getElementById('my-records-modal').style.display = 'none';
        });
        
        // ä¿®å¤ï¼šç‚¹å‡»å¤–éƒ¨å…³é—­å¼¹çª—æ—¶ï¼Œé¿å…æ–‡æœ¬é€‰æ‹©æ—¶æ„å¤–è§¦å‘
        const myRecordsModal = document.getElementById('my-records-modal');
        if (myRecordsModal) {
            let isMouseDownOnMyRecordsOverlay = false;
            
            myRecordsModal.addEventListener('mousedown', (e) => {
                isMouseDownOnMyRecordsOverlay = (e.target === myRecordsModal);
            });
            
            myRecordsModal.addEventListener('click', (e) => {
                if (e.target === myRecordsModal && isMouseDownOnMyRecordsOverlay) {
                    myRecordsModal.style.display = 'none';
                }
                isMouseDownOnMyRecordsOverlay = false;
            });
        }

        // ä¿ç•™æ‰‹åŠ¨æŸ¥è¯¢åŠŸèƒ½ï¼ˆä½†éšè—äº†è¾“å…¥åŒºåŸŸï¼‰
        document.getElementById('query-records-btn').addEventListener('click', async () => {
            const username = document.getElementById('query-username').value.trim();
            if (!username) {
                showError(I18nManager.t('enterUsername'));
                return;
            }

            const loading = showLoading(I18nManager.t('searching'));
            try {
                // ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œé€šè¿‡ Nginx åå‘ä»£ç†ï¼Œå¸¦ä¸Šè®¤è¯ä¿¡æ¯
                const headers = {};
                if (currentUser && currentUser.token) {
                    headers['Authorization'] = `Bearer ${currentUser.token}`;
                }
                const response = await fetch(`${API_BASE}/rankings/my-records?username=${encodeURIComponent(username)}`, { headers });
                const result = await response.json();
                loading.close();

                if (result.code === 200 && result.data.records.length > 0) {
                    displayMyRecords(result.data);
                } else {
                    document.getElementById('username-input-section').style.display = 'none';
                    document.getElementById('my-records-content').style.display = 'none';
                    document.getElementById('no-records-message').style.display = 'block';
                }
            } catch (error) {
                loading.close();
                showError(I18nManager.t('searchError') + error.message);
            }
        });

        function displayMyRecords(data) {
            document.getElementById('username-input-section').style.display = 'none';
            document.getElementById('my-records-content').style.display = 'block';
            document.getElementById('no-records-message').style.display = 'none';

            // æ˜¾ç¤ºç»Ÿè®¡
            document.getElementById('total-count').textContent = data.total;
            document.getElementById('pending-count').textContent = data.stats.pending;
            document.getElementById('approved-count').textContent = data.stats.approved;
            document.getElementById('rejected-count').textContent = data.stats.rejected;

            // æ˜¾ç¤ºè®°å½•åˆ—è¡¨
            const recordsList = document.getElementById('records-list');
            recordsList.innerHTML = data.records.map(record => {
                const statusText = I18nManager.t('status' + record.status.charAt(0).toUpperCase() + record.status.slice(1));
                const statusInfo = {
                    pending: { icon: 'â³', text: statusText, color: '#ffc107', bg: 'rgba(255, 193, 7, 0.1)' },
                    approved: { icon: 'âœ…', text: statusText, color: '#4caf50', bg: 'rgba(76, 175, 80, 0.1)' },
                    rejected: { icon: 'âŒ', text: statusText, color: '#f44336', bg: 'rgba(244, 67, 54, 0.1)' }
                }[record.status];

                const date = new Date(record.created_at).toLocaleString(I18nManager.currentLang === 'zh' ? 'zh-CN' : 'en-US');
                const timeFormatted = Math.floor(record.time / 60).toString().padStart(2, '0') + ':' + 
                                     (record.time % 60).toString().padStart(2, '0');

                return `
                    <div style="background: var(--lc-bg-card); border: 1px solid var(--lc-border); border-radius: 6px; padding: 15px; margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div>
                                <div style="font-size: 1rem; color: var(--lc-text); margin-bottom: 5px;">
                                    <strong>${record.sinner}</strong> Â· ${record.persona}
                                </div>
                                <div style="color: var(--lc-text-muted); font-size: 0.85rem;">
                                    <i class="fas fa-layer-group"></i> ç¬¬${record.floor_level}å±‚ Â· 
                                    <i class="fas fa-clock"></i> ${timeFormatted}
                                </div>
                            </div>
                            <div style="background: ${statusInfo.bg}; color: ${statusInfo.color}; padding: 6px 12px; border-radius: 4px; font-size: 0.85rem; font-weight: 600; white-space: nowrap;">
                                ${statusInfo.icon} ${statusInfo.text}
                            </div>
                        </div>
                        <div style="color: var(--lc-text-muted); font-size: 0.8rem; border-top: 1px solid var(--lc-border); padding-top: 8px;">
                            <i class="fas fa-calendar"></i> ${I18nManager.t('submitTime')}: ${date}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–ç”¨æˆ·UI
        updateUserUI();
    </script>

    <!-- å¸®åŠ©å¼¹çª—å‡½æ•° -->
    <script>
        function showHelpModal() {
            document.getElementById('help-modal').style.display = 'flex';
        }
        
        function closeHelpModal() {
            document.getElementById('help-modal').style.display = 'none';
        }
    </script>
</body>
</html>
