<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äººæ ¼å•é€šæ”»ç•¥ - ä»Šå¤©è›‹ç­’ä»€ä¹ˆ</title>
    <link rel="stylesheet" href="/css/reset.css">
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/limbus-theme-v2.css">
    <link rel="stylesheet" href="/css/module/guides.css">
    <link rel="stylesheet" href="/css/custom-dialog.css">
    <link rel="stylesheet" href="/css/auth-module.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Quillå¯Œæ–‡æœ¬ç¼–è¾‘å™¨ -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    
    <!-- DOMPurifyå®‰å…¨é˜²æŠ¤ -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    
    <!-- æ­£æ–‡å›¾ç‰‡ä¸Šä¼ æ ·å¼ -->
    <style>
        .content-image-item {
            animation: scaleIn 0.25s ease;
        }
        .content-image-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .content-image-item ::-webkit-scrollbar {
            width: 3px;
        }
        .content-image-item ::-webkit-scrollbar-thumb {
            background: rgba(201,169,97,0.5);
            border-radius: 2px;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .image-viewer-modal {
            animation: fadeIn 0.2s ease;
        }
        /* ç‚¹èµæŒ‰é’®æ ·å¼ */
        .like-btn {
            transition: all 0.3s ease;
            background: linear-gradient(135deg, rgba(201, 79, 79, 0.1), rgba(201, 79, 79, 0.05));
            border: 1px solid rgba(201, 79, 79, 0.3);
            color: var(--lc-red);
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(201, 79, 79, 0.15);
        }
        .like-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, rgba(201, 79, 79, 0.2), rgba(201, 79, 79, 0.1));
            border-color: rgba(201, 79, 79, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(201, 79, 79, 0.25);
        }
        .like-btn.liked {
            background: linear-gradient(135deg, var(--lc-red), #a63d3d);
            border-color: var(--lc-red);
            color: #fff;
            box-shadow: 0 4px 15px rgba(201, 79, 79, 0.4);
        }
        .like-btn.liked i {
            color: #fff;
            animation: heartBeat 0.5s ease;
        }
        @keyframes heartBeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        .like-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* åˆ†äº«æŒ‰é’®æ ·å¼ */
        .share-btn {
            transition: all 0.3s ease;
            background: linear-gradient(135deg, rgba(201, 169, 97, 0.1), rgba(201, 169, 97, 0.05));
            border: 1px solid rgba(201, 169, 97, 0.3);
            color: var(--lc-gold);
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(201, 169, 97, 0.15);
        }
        .share-btn:hover {
            background: linear-gradient(135deg, rgba(201, 169, 97, 0.2), rgba(201, 169, 97, 0.1));
            border-color: rgba(201, 169, 97, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(201, 169, 97, 0.25);
        }
        
        /* æŒ‰é’®å®¹å™¨ */
        .guide-detail-actions {
            display: flex;
            gap: 16px;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid rgba(201, 169, 97, 0.15);
        }
        
        /* å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡†æ ·å¼ */
        .image-preview-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .image-preview-toolbar {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            padding: 10px 20px;
            background: rgba(30, 30, 40, 0.9);
            border: 1px solid rgba(201, 169, 97, 0.3);
            border-radius: 30px;
            z-index: 10001;
            backdrop-filter: blur(10px);
        }
        .image-preview-toolbar button {
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            color: var(--lc-gold);
            font-size: 1rem;
            cursor: pointer;
            border-radius: 50%;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .image-preview-toolbar button:hover {
            background: rgba(201, 169, 97, 0.2);
        }
        .image-preview-container {
            flex: 1;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            overflow: auto;
            padding: 80px 20px 20px;
            cursor: grab;
        }
        .image-preview-container img {
            max-width: none;
            max-height: none;
            border-radius: 4px;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.5);
            transition: transform 0.2s ease;
            transform-origin: center top;
            user-select: none;
        }
        
        /* è§†é¢‘å®¹å™¨æ ·å¼ */
        .guide-video {
            width: 100%;
            height: 400px;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            margin: 16px 0;
        }
        
        .video-placeholder {
            width: 100%;
            height: 100%;
            position: relative;
            cursor: pointer;
        }
        
        .guide-video iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        /* è§†é¢‘å°é¢ */
        .video-cover {
            width: 100%;
            height: 100%;
            position: relative;
            cursor: pointer;
            overflow: hidden;
        }
        
        .video-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .video-cover::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 1;
        }
        
        /* æ’­æ”¾è¦†ç›–å±‚ */
        .play-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .play-overlay:hover {
            transform: translate(-50%, -50%) scale(1.05);
        }
        
        .play-overlay i {
            width: 80px;
            height: 80px;
            background: rgba(201, 169, 97, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: var(--lc-bg);
            box-shadow: 0 4px 20px rgba(201, 169, 97, 0.3);
            transition: all 0.3s ease;
        }
        
        .play-overlay:hover i {
            background: var(--lc-gold);
            box-shadow: 0 6px 25px rgba(201, 169, 97, 0.5);
        }
        
        .play-overlay span {
            color: #fff;
            font-size: 14px;
            font-weight: 500;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
        }
        
        /* æ–°çª—å£æ‰“å¼€æŒ‰é’® */
        .open-new-tab {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid var(--lc-gold);
            border-radius: 8px;
            color: var(--lc-gold);
            padding: 8px 12px;
            font-size: 12px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 6px;
            z-index: 3;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .open-new-tab:hover {
            background: var(--lc-gold);
            color: var(--lc-bg);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(201, 169, 97, 0.4);
        }
        
        .open-new-tab i {
            font-size: 10px;
        }
        
        /* è§†é¢‘åŠ è½½çŠ¶æ€ */
        .video-loading, .video-error {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #fff;
            text-align: center;
            padding: 20px;
        }
        
        .video-loading i, .video-error i {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .video-error a {
            color: #3498db;
            text-decoration: underline;
            margin-top: 12px;
        }
        
        /* æ”»ç•¥è¯¦æƒ…æ ·å¼ */
        .guide-detail {
            padding: 30px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .guide-detail-header {
            border-bottom: 1px solid var(--lc-border);
            padding-bottom: 20px;
            margin-bottom: 24px;
        }
        
        .guide-detail-header h2 {
            font-size: 28px;
            color: var(--lc-text);
            margin-bottom: 16px;
            font-weight: 600;
            line-height: 1.3;
        }
        
        .guide-detail-meta {
            display: flex;
            gap: 24px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        
        .guide-author, .guide-date, .guide-views {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--lc-text-secondary);
            font-size: 14px;
        }
        
        .guide-author i, .guide-date i, .guide-views i {
            color: var(--lc-gold);
            font-size: 12px;
        }
        
        .guide-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
        }
        
        .tag {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .tag-sinner {
            background: rgba(201, 169, 97, 0.2);
            color: var(--lc-gold);
            border: 1px solid var(--lc-gold);
        }
        
        .tag-persona {
            background: rgba(74, 158, 255, 0.2);
            color: var(--lc-settings);
            border: 1px solid var(--lc-settings);
        }
        
        .tag-floor {
            background: rgba(155, 89, 182, 0.2);
            color: var(--lc-timer);
            border: 1px solid var(--lc-timer);
        }
        
        .tag:not(.tag-sinner):not(.tag-persona):not(.tag-floor) {
            background: rgba(160, 160, 160, 0.2);
            color: var(--lc-text-secondary);
            border: 1px solid var(--lc-text-secondary);
        }
        
        .guide-detail-content {
            line-height: 1.6;
        }
        
        .guide-description {
            background: var(--lc-bg-secondary);
            border: 1px solid var(--lc-border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            color: var(--lc-text);
            font-size: 15px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .guide-media-container {
            margin-top: 20px;
        }
        
        .guide-media-title {
            color: var(--lc-gold);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .guide-media-title i {
            font-size: 16px;
        }
        
        /* å“åº”å¼ä¼˜åŒ– */
        @media (max-width: 768px) {
            .guide-detail {
                padding: 20px;
            }
            
            .guide-detail-header h2 {
                font-size: 24px;
            }
            
            .guide-detail-meta {
                gap: 16px;
            }
            
            .guide-tags {
                gap: 6px;
            }
            
            .tag {
                padding: 4px 8px;
                font-size: 11px;
            }
        }
        
        /* æ»šåŠ¨æ¡ç¾åŒ– */
        .guide-detail::-webkit-scrollbar {
            width: 8px;
        }
        
        .guide-detail::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }
        
        .guide-detail::-webkit-scrollbar-thumb {
            background: var(--lc-gold);
            border-radius: 4px;
        }
        
        .guide-detail::-webkit-scrollbar-thumb:hover {
            background: var(--lc-gold-light);
        }
        
        /* Quillå¯Œæ–‡æœ¬ç¼–è¾‘å™¨æš—è‰²ä¸»é¢˜ */
        .ql-toolbar.ql-snow {
            background: var(--lc-bg-secondary);
            border: 1px solid var(--lc-border);
            border-radius: 8px 8px 0 0;
            padding: 12px;
        }

        .ql-container.ql-snow {
            background: var(--lc-bg-secondary);
            border: 1px solid var(--lc-border);
            border-top: none;
            border-radius: 0 0 8px 8px;
            color: var(--lc-text);
            font-family: inherit;
        }

        .ql-editor {
            color: var(--lc-text);
            font-size: 15px;
            line-height: 1.8;
            min-height: 300px;
            padding: 20px;
        }

        .ql-editor.ql-blank::before {
            color: var(--lc-text-muted);
            font-style: normal;
        }

        /* å·¥å…·æ å›¾æ ‡é¢œè‰² */
        .ql-snow .ql-stroke {
            stroke: var(--lc-text-secondary);
        }

        .ql-snow .ql-fill {
            fill: var(--lc-text-secondary);
        }

        .ql-snow .ql-picker-label {
            color: var(--lc-text);
        }

        .ql-snow .ql-picker-options {
            background: var(--lc-bg-secondary);
            border: 1px solid var(--lc-border);
        }

        .ql-snow .ql-picker-item:hover {
            color: var(--lc-gold);
        }

        /* æ¿€æ´»çŠ¶æ€ */
        .ql-toolbar button:hover,
        .ql-toolbar button:focus,
        .ql-toolbar button.ql-active {
            color: var(--lc-gold) !important;
        }

        .ql-toolbar button:hover .ql-stroke,
        .ql-toolbar button:focus .ql-stroke,
        .ql-toolbar button.ql-active .ql-stroke {
            stroke: var(--lc-gold) !important;
        }

        .ql-toolbar button:hover .ql-fill,
        .ql-toolbar button:focus .ql-fill,
        .ql-toolbar button.ql-active .ql-fill {
            fill: var(--lc-gold) !important;
        }

        /* ä¸‹æ‹‰èœå•æ ·å¼ */
        .ql-snow .ql-picker.ql-expanded .ql-picker-label {
            border-color: var(--lc-gold);
        }

        /* å¯Œæ–‡æœ¬å†…å®¹æ¸²æŸ“æ ·å¼ */
        .richtext-content {
            line-height: 1.8;
        }

        .richtext-content h1 {
            color: var(--lc-gold);
            font-size: 28px;
            font-weight: 600;
            margin: 28px 0 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--lc-border);
        }

        .richtext-content h2 {
            color: var(--lc-gold);
            font-size: 24px;
            font-weight: 600;
            margin: 24px 0 14px;
        }

        .richtext-content h3 {
            color: var(--lc-gold);
            font-size: 20px;
            font-weight: 600;
            margin: 20px 0 12px;
        }

        .richtext-content p {
            margin: 12px 0;
        }

        .richtext-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 16px 0;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .richtext-content img:hover {
            transform: scale(1.02);
        }

        .richtext-content blockquote {
            border-left: 4px solid var(--lc-gold);
            padding-left: 16px;
            margin: 16px 0;
            color: var(--lc-text-secondary);
            font-style: italic;
        }

        .richtext-content code {
            background: var(--lc-bg);
            padding: 3px 8px;
            border-radius: 4px;
            color: var(--lc-gold);
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .richtext-content pre {
            background: var(--lc-bg);
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 16px 0;
        }

        .richtext-content pre code {
            background: none;
            padding: 0;
        }

        .richtext-content a {
            color: var(--lc-settings);
            text-decoration: underline;
            transition: color 0.2s;
        }

        .richtext-content a:hover {
            color: var(--lc-gold);
        }

        .richtext-content ul,
        .richtext-content ol {
            padding-left: 28px;
            margin: 12px 0;
        }

        .richtext-content li {
            margin: 8px 0;
        }

        .richtext-content strong {
            font-weight: 600;
            color: var(--lc-text);
        }

        .richtext-content em {
            font-style: italic;
            color: var(--lc-text-secondary);
        }

        /* ç¼–è¾‘å™¨å®¹å™¨ */
        .editor-wrapper {
            margin-bottom: 16px;
        }

        .editor-tips {
            font-size: 12px;
            color: var(--lc-text-muted);
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .editor-tips i {
            color: var(--lc-gold);
        }
    </style>

</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <nav class="top-nav">
        <div class="nav-brand">
            <div class="logo-icon logo-icon-guides">
                <i class="fas fa-book-open"></i>
            </div>
            <div class="logo-text">
                <h1>äººæ ¼å•é€šæ”»ç•¥</h1>
                <span class="logo-subtitle">Limbus Company Â· ç¤¾åŒºæ”»ç•¥ä¸­å¿ƒ</span>
            </div>
        </div>
        <div class="nav-meta">
            <div class="version-tag">
                <span class="label">ç‰ˆæœ¬</span>
                <span class="value">1.6.0</span>
            </div>
            <button onclick="openUserSubmitModal()" class="nav-btn nav-btn-guides">
                <i class="fas fa-plus"></i>
                <span>æŠ•ç¨¿æ”»ç•¥</span>
            </button>
            <button id="user-auth-btn" onclick="openAuthModal()" class="nav-btn nav-btn-help">
                <i class="fas fa-user"></i>
                <span id="user-auth-text">ç™»å½•/æ³¨å†Œ</span>
            </button>
            <a href="/" class="nav-btn nav-btn-primary" style="text-decoration:none;">
                <i class="fas fa-dice"></i>
                <span>å»æŠ½äººæ ¼</span>
            </a>
            <a href="/global-ranking" class="nav-btn nav-btn-ranking" style="text-decoration:none;">
                <i class="fas fa-trophy"></i>
                <span>æ’è¡Œæ¦œ</span>
            </a>
        </div>
    </nav>

    <!-- ä¸»å®¹å™¨ -->
    <div class="guides-container">
        <!-- ç­›é€‰é¢æ¿ -->
        <aside class="guides-filters">
            <div class="filter-section">
                <h3 class="filter-title"><i class="fas fa-user"></i> é€‰æ‹©ç½ªäºº</h3>
                <div class="filter-group" id="sinner-filters">
                    <button class="filter-btn active" data-sinner="all">
                        <i class="fas fa-th"></i> å…¨éƒ¨
                    </button>
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <div class="filter-section">
                <h3 class="filter-title"><i class="fas fa-masks-theater"></i> é€‰æ‹©äººæ ¼</h3>
                <div class="filter-group" id="persona-filters">
                    <button class="filter-btn active" data-persona="all">
                        <i class="fas fa-layer-group"></i> å…¨éƒ¨äººæ ¼
                    </button>
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <div class="filter-section">
                <h3 class="filter-title"><i class="fas fa-signal"></i> æŒ‘æˆ˜å±‚æ•°</h3>
                <div class="floor-filter-grid" id="floor-filters">
                    <button class="filter-btn active" data-floor="all">å…¨éƒ¨</button>
                    <button class="filter-btn" data-floor="5-2">5-H</button>
                    <button class="filter-btn" data-floor="10">10</button>
                    <button class="filter-btn" data-floor="15">15</button>
                </div>
            </div>

            <div class="filter-section">
                <h3 class="filter-title"><i class="fas fa-sort"></i> æ’åºæ–¹å¼</h3>
                <select id="sort-select" class="sort-select">
                    <option value="created_at">æœ€æ–°å‘å¸ƒ</option>
                    <option value="views">æœ€å¤šæµè§ˆ</option>
                    <option value="likes">æœ€å¤šç‚¹èµ</option>
                </select>
            </div>
        </aside>

        <!-- æ”»ç•¥åˆ—è¡¨åŒºåŸŸ -->
        <main class="guides-main">
            <!-- æœç´¢æ¡† -->
            <div class="search-box" style="margin-bottom:16px;">
                <div style="display:flex;gap:10px;align-items:center;background:var(--lc-bg-secondary);border:1px solid var(--lc-border);border-radius:8px;padding:8px 12px;">
                    <i class="fas fa-search" style="color:var(--lc-text-muted);"></i>
                    <input type="text" id="guide-search-input" placeholder="æœç´¢æ”»ç•¥æ ‡é¢˜ã€ä½œè€…ã€ç½ªäººã€äººæ ¼..." 
                           style="flex:1;background:transparent;border:none;color:var(--lc-text);font-size:0.9rem;outline:none;"
                           onkeyup="handleSearchInput(event)">
                    <button onclick="clearSearch()" id="clear-search-btn" style="display:none;background:transparent;border:none;color:var(--lc-text-muted);cursor:pointer;padding:4px;">
                        <i class="fas fa-times"></i>
                    </button>
                    <button onclick="performSearch()" style="padding:6px 16px;background:var(--lc-gold);border:none;border-radius:6px;color:#1a1a2e;font-size:0.85rem;cursor:pointer;font-weight:600;">
                        æœç´¢
                    </button>
                </div>
            </div>

            <!-- å½“å‰ç­›é€‰çŠ¶æ€ -->
            <div class="guides-header">
                <div class="current-filter">
                    <span id="current-sinner">å…¨éƒ¨ç½ªäºº</span>
                    <span class="separator">Â·</span>
                    <span id="current-persona">å…¨éƒ¨äººæ ¼</span>
                    <span class="separator">Â·</span>
                    <span id="current-floor">å…¨éƒ¨å±‚æ•°</span>
                    <span id="search-status" style="display:none;color:var(--lc-gold);margin-left:8px;"></span>
                </div>
                <div class="guides-count">
                    å…± <span id="total-guides">0</span> ç¯‡æ”»ç•¥
                </div>
            </div>

            <!-- æ”»ç•¥å¡ç‰‡ç½‘æ ¼ -->
            <div class="guides-grid" id="guides-grid">
                <!-- åŠ¨æ€ç”Ÿæˆæ”»ç•¥å¡ç‰‡ -->
            </div>

            <!-- åˆ†é¡µ -->
            <div class="pagination" id="pagination">
                <!-- åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </main>
    </div>

    <!-- æ”»ç•¥è¯¦æƒ…å¼¹çª— -->
    <div class="modal-overlay" id="guide-modal">
        <div class="modal-content guide-modal-content">
            <button class="modal-close" onclick="closeGuideModal()">
                âœ•
            </button>
            <div class="guide-detail" id="guide-detail">
                <!-- åŠ¨æ€å¡«å…… -->
            </div>
        </div>
    </div>

    <!-- åŠ è½½åŠ¨ç”» -->
    <div class="loading-overlay" id="loading">
        <div class="loading-spinner">
            â­•
            <span>åŠ è½½ä¸­...</span>
        </div>
    </div>

    <!-- API é…ç½® -->
    <script src="/js/config.js"></script>
    
    <script type="module">
        import { sinnerData } from '/data/characters.js';
        import { createGuideImageManager } from '/js/modules/guideImageUploader.js';

        // ä½¿ç”¨å…¨å±€ API_BASE æˆ–å›é€€åˆ°ç›¸å¯¹è·¯å¾„
        const API_BASE = window.API_BASE || '/api';
        
        // å›¾ç‰‡ä¸Šä¼ é…ç½®
        const UPLOAD_CONFIG = {
            maxFileSize: 10 * 1024 * 1024 // 10MB é™åˆ¶
        };
        
        let currentState = {
            sinner: 'all',
            persona: 'all',
            floor: 'all',
            sortBy: 'created_at',
            page: 1,
            pageSize: 12,
            searchQuery: ''
        };
        
        // æœç´¢ç¼“å­˜
        let searchTimeout = null;
        let allGuidesCache = []; // ç”¨äºå®¢æˆ·ç«¯æœç´¢çš„ç¼“å­˜

        // ç”¨æˆ·è®¤è¯çŠ¶æ€
        let currentUser = JSON.parse(localStorage.getItem('limbus_user') || 'null');
        
        // æ›´æ–°ç”¨æˆ·UI
        function updateUserUI() {
            const authBtn = document.getElementById('user-auth-btn');
            const authText = document.getElementById('user-auth-text');
            currentUser = JSON.parse(localStorage.getItem('limbus_user') || 'null');
            if (currentUser) {
                authText.textContent = currentUser.username;
                authBtn.title = 'ç‚¹å‡»ç™»å‡º';
                // ç”¨æˆ·ç™»å½•ååŠ è½½ä»Šæ—¥ç‚¹èµåˆ—è¡¨
                loadTodayLikes();
            } else {
                authText.textContent = 'ç™»å½•/æ³¨å†Œ';
                authBtn.title = '';
                // æ¸…ç©ºç‚¹èµåˆ—è¡¨
                todayLikedGuideIds = [];
            }
        }
        
        // ç›‘å¬ storage äº‹ä»¶ï¼Œå®ç°å¤šé¡µé¢ç™»å½•çŠ¶æ€åŒæ­¥
        window.addEventListener('storage', (e) => {
            if (e.key === 'limbus_user') {
                updateUserUI();
            }
        });
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initSinnerFilters();
            initEventListeners();
            loadGuides();
            updateUserUI();
            
            // æ£€æŸ¥æ˜¯å¦ä»æ’è¡Œæ¦œé¡µé¢è·³è½¬è¿‡æ¥éœ€è¦æ‰“å¼€æ”»ç•¥æäº¤è¡¨å•
            if (localStorage.getItem('open_guide_submit') === 'true') {
                localStorage.removeItem('open_guide_submit');
                // å»¶è¿Ÿæ‰“å¼€ï¼Œç¡®ä¿é¡µé¢åŠ è½½å®Œæˆ
                setTimeout(() => {
                    if (currentUser) {
                        openUserSubmitModal();
                        showMessage('è¯·å¡«å†™è¯¦ç»†çš„æ”»ç•¥å†…å®¹åæäº¤', 'info');
                    } else {
                        showMessage('è¯·å…ˆç™»å½•åå†æŠ•ç¨¿æ”»ç•¥', 'warning');
                        setTimeout(() => openAuthModal(), 500);
                    }
                }, 500);
            }
        });

        // åˆå§‹åŒ–ç½ªäººç­›é€‰æŒ‰é’®
        function initSinnerFilters() {
            const container = document.getElementById('sinner-filters');
            
            // ä¸º"å…¨éƒ¨"æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬
            const allBtn = container.querySelector('[data-sinner="all"]');
            if (allBtn) {
                allBtn.addEventListener('click', () => {
                    setActiveFilter('sinner', 'all');
                    updatePersonaFilters('all');
                });
            }
            
            sinnerData.forEach(sinner => {
                const btn = document.createElement('button');
                btn.className = 'filter-btn sinner-btn';
                btn.dataset.sinner = sinner.name.split(' ')[0];
                btn.innerHTML = `
                    <img src="${sinner.avatar}" alt="${sinner.name}" class="sinner-avatar-mini">
                    <span>${sinner.name.split(' ')[0]}</span>
                `;
                btn.addEventListener('click', () => {
                    setActiveFilter('sinner', btn.dataset.sinner);
                    updatePersonaFilters(btn.dataset.sinner);
                });
                container.appendChild(btn);
            });
        }

        // æ›´æ–°äººæ ¼ç­›é€‰æŒ‰é’®
        function updatePersonaFilters(sinnerName) {
            const container = document.getElementById('persona-filters');
            container.innerHTML = `
                <button class="filter-btn active" data-persona="all" id="persona-all-btn">
                    ğŸ”½ å…¨éƒ¨äººæ ¼
                </button>
            `;
            
            // ä¸º"å…¨éƒ¨äººæ ¼"æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬
            document.getElementById('persona-all-btn').addEventListener('click', () => {
                setActiveFilter('persona', 'all');
            });

            if (sinnerName === 'all') return;

            const sinner = sinnerData.find(s => s.name.includes(sinnerName));
            if (sinner) {
                sinner.personalities.forEach(persona => {
                    const btn = document.createElement('button');
                    btn.className = 'filter-btn persona-btn';
                    btn.dataset.persona = persona.name;
                    btn.innerHTML = `<span>${persona.name}</span>`;
                    btn.addEventListener('click', () => setActiveFilter('persona', persona.name));
                    container.appendChild(btn);
                });
            }
        }

        // è®¾ç½®æ´»è·ƒç­›é€‰
        function setActiveFilter(type, value) {
            currentState[type] = value;
            currentState.page = 1;

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll(`[data-${type}]`).forEach(btn => {
                btn.classList.toggle('active', btn.dataset[type] === value);
            });

            // æ›´æ–°æ˜¾ç¤ºæ–‡æœ¬
            updateFilterDisplay();
            loadGuides();
        }

        // æœç´¢åŠŸèƒ½
        window.handleSearchInput = function(event) {
            const input = document.getElementById('guide-search-input');
            const clearBtn = document.getElementById('clear-search-btn');
            
            // æ˜¾ç¤º/éšè—æ¸…ç©ºæŒ‰é’®
            clearBtn.style.display = input.value ? 'block' : 'none';
            
            // å®æ—¶æœç´¢ï¼ˆå»¶è¿Ÿ300msï¼‰
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                performSearch();
            }, 300);
            
            // å›è½¦ç›´æ¥æœç´¢
            if (event.key === 'Enter') {
                clearTimeout(searchTimeout);
                performSearch();
            }
        };
        
        window.performSearch = function() {
            const input = document.getElementById('guide-search-input');
            const query = input.value.trim();
            
            currentState.searchQuery = query;
            currentState.page = 1;
            
            // æ›´æ–°æœç´¢çŠ¶æ€æ˜¾ç¤º
            const searchStatus = document.getElementById('search-status');
            if (query) {
                searchStatus.textContent = `Â· æœç´¢: "${query}"`;
                searchStatus.style.display = 'inline';
            } else {
                searchStatus.style.display = 'none';
            }
            
            loadGuides();
        };
        
        window.clearSearch = function() {
            const input = document.getElementById('guide-search-input');
            input.value = '';
            document.getElementById('clear-search-btn').style.display = 'none';
            currentState.searchQuery = '';
            currentState.page = 1;
            document.getElementById('search-status').style.display = 'none';
            loadGuides();
        };

        // æ›´æ–°ç­›é€‰æ˜¾ç¤º
        function updateFilterDisplay() {
            const sinnerName = currentState.sinner === 'all' ? 'å…¨éƒ¨ç½ªäºº' : currentState.sinner;
            const personaName = currentState.persona === 'all' ? 'å…¨éƒ¨äººæ ¼' : currentState.persona;
            const floorName = currentState.floor === 'all' ? 'å…¨éƒ¨å±‚æ•°' : `ç¬¬${currentState.floor}å±‚`;

            document.getElementById('current-sinner').textContent = sinnerName;
            document.getElementById('current-persona').textContent = personaName;
            document.getElementById('current-floor').textContent = floorName;
        }

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
        function initEventListeners() {
            // å±‚æ•°ç­›é€‰
            document.querySelectorAll('#floor-filters .filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    setActiveFilter('floor', btn.dataset.floor);
                });
            });

            // æ’åº
            document.getElementById('sort-select').addEventListener('change', (e) => {
                currentState.sortBy = e.target.value;
                currentState.page = 1;
                loadGuides();
            });

            // ç‚¹å‡»é®ç½©å…³é—­å¼¹çª—
            document.getElementById('guide-modal').addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay')) {
                    closeGuideModal();
                }
            });
        }

        // åŠ è½½æ”»ç•¥åˆ—è¡¨
        async function loadGuides() {
            showLoading(true);
            try {
                const params = new URLSearchParams({
                    page: 1,
                    pageSize: 1000, // è·å–æ›´å¤šæ•°æ®ç”¨äºå®¢æˆ·ç«¯æœç´¢
                    sortBy: currentState.sortBy
                });
                if (currentState.sinner !== 'all') params.append('sinner', currentState.sinner);
                if (currentState.persona !== 'all') params.append('persona', currentState.persona);
                if (currentState.floor !== 'all') params.append('floorLevel', currentState.floor);
                // æ·»åŠ æœç´¢å‚æ•°ï¼ˆå¦‚æœåç«¯æ”¯æŒï¼‰
                if (currentState.searchQuery) params.append('keyword', currentState.searchQuery);

                const response = await fetch(`${API_BASE}/guides/list?${params}`);
                const result = await response.json();

                if (result.success) {
                    let guides = result.data.guides;
                    
                    // å¦‚æœæœ‰æœç´¢å…³é”®è¯ï¼Œåœ¨å®¢æˆ·ç«¯è¿›è¡Œè¿‡æ»¤ï¼ˆä½œä¸ºåç«¯æœç´¢çš„åå¤‡ï¼‰
                    if (currentState.searchQuery) {
                        const query = currentState.searchQuery.toLowerCase();
                        guides = guides.filter(guide => {
                            return (
                                (guide.title && guide.title.toLowerCase().includes(query)) ||
                                (guide.author && guide.author.toLowerCase().includes(query)) ||
                                (guide.sinner && guide.sinner.toLowerCase().includes(query)) ||
                                (guide.persona && guide.persona.toLowerCase().includes(query)) ||
                                (guide.content && guide.content.toLowerCase().includes(query)) ||
                                (guide.tags && guide.tags.some(tag => tag.toLowerCase().includes(query)))
                            );
                        });
                    }
                    
                    // ç¼“å­˜ç»“æœ
                    allGuidesCache = guides;
                    
                    // åˆ†é¡µæ˜¾ç¤º
                    const total = guides.length;
                    const start = (currentState.page - 1) * currentState.pageSize;
                    const end = start + currentState.pageSize;
                    const pageGuides = guides.slice(start, end);
                    
                    renderGuides(pageGuides);
                    renderPagination({
                        page: currentState.page,
                        totalPages: Math.ceil(total / currentState.pageSize) || 1,
                        total: total
                    });
                    document.getElementById('total-guides').textContent = total;
                }
            } catch (error) {
                console.error('åŠ è½½æ”»ç•¥å¤±è´¥:', error);
                showEmptyState('åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ');
            }
            showLoading(false);
        }

        // æ¸²æŸ“æ”»ç•¥å¡ç‰‡
        function renderGuides(guides) {
            const container = document.getElementById('guides-grid');
            
            if (guides.length === 0) {
                showEmptyState('æš‚æ— è¯¥ç­›é€‰æ¡ä»¶ä¸‹çš„æ”»ç•¥');
                return;
            }

            container.innerHTML = guides.map(guide => {
                // è·å–è§†é¢‘å°é¢ï¼ˆå¦‚æœæ˜¯è§†é¢‘ç±»å‹ä¸”æœ‰é“¾æ¥ï¼‰
                let coverImage = guide.coverUrl;
                if (!coverImage && guide.mediaType === 'video' && guide.mediaUrls && guide.mediaUrls.length > 0) {
                    coverImage = getVideoCover(guide.mediaUrls[0]);
                }
                
                // è·å–å‰3ä¸ªæ ‡ç­¾æ˜¾ç¤º
                const displayTags = (guide.tags || []).slice(0, 3);
                
                // åª’ä½“ç±»å‹å›¾æ ‡
                const mediaIcon = guide.mediaType === 'video' ? 'fa-video' : guide.mediaType === 'image' ? 'fa-image' : 'fa-file-alt';
                
                return `
                <div class="guide-card" onclick="window.openGuideDetail(${guide.id})">
                    <div class="guide-cover">
                        ${coverImage ? 
                            `<img src="${coverImage}" alt="${guide.title}" loading="lazy">` :
                            `<div class="guide-cover-placeholder ${guide.mediaType}">
                                <i class="fas ${mediaIcon}"></i>
                                <span>${getMediaLabel(guide.mediaType)}</span>
                            </div>`
                        }
                        <div class="guide-media-badge">
                            <i class="fas ${mediaIcon}"></i>
                            ${getMediaLabel(guide.mediaType)}
                        </div>
                        <div class="guide-floor-badge">${guide.floorLevel}å±‚</div>
                    </div>
                    <div class="guide-info">
                        <h3 class="guide-title">${guide.title}</h3>
                        <div class="guide-meta">
                            <span class="guide-sinner">${guide.sinner} Â· ${guide.persona}</span>
                        </div>
                        ${displayTags.length > 0 ? `
                        <div class="guide-tags-preview">
                            ${displayTags.map(tag => `<span class="guide-tag">${tag}</span>`).join('')}
                        </div>
                        ` : ''}
                        <div class="guide-stats">
                            <span><i class="fas fa-eye"></i> ${guide.views || 0}</span>
                            <span><i class="fas fa-heart"></i> ${guide.likes || 0}</span>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        // è·å–åª’ä½“å›¾æ ‡
        function getMediaIcon(type) {
            const icons = {
                video: 'video',
                image: 'image',
                text: 'file-alt',
                mixed: 'layer-group'
            };
            return icons[type] || 'file-alt';
        }

        // è·å–åª’ä½“æ ‡ç­¾
        function getMediaLabel(type) {
            const labels = {
                video: 'è§†é¢‘',
                image: 'å›¾æ–‡',
                text: 'çº¯æ–‡',
                mixed: 'æ··åˆ'
            };
            return labels[type] || 'å›¾æ–‡';
        }

        // æ¸²æŸ“åˆ†é¡µ
        function renderPagination(pagination) {
            const container = document.getElementById('pagination');
            const { page, totalPages } = pagination;

            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = '';
            
            // ä¸Šä¸€é¡µ
            html += `<button class="page-btn" ${page <= 1 ? 'disabled' : ''} onclick="window.changePage(${page - 1})">
                â†
            </button>`;

            // é¡µç 
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= page - 2 && i <= page + 2)) {
                    html += `<button class="page-btn ${i === page ? 'active' : ''}" onclick="window.changePage(${i})">${i}</button>`;
                } else if (i === page - 3 || i === page + 3) {
                    html += `<span class="page-ellipsis">...</span>`;
                }
            }

            // ä¸‹ä¸€é¡µ
            html += `<button class="page-btn" ${page >= totalPages ? 'disabled' : ''} onclick="window.changePage(${page + 1})">
                â†’
            </button>`;

            container.innerHTML = html;
        }

        // åˆ‡æ¢é¡µé¢
        window.changePage = function(page) {
            currentState.page = page;
            loadGuides();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        // æ‰“å¼€æ”»ç•¥è¯¦æƒ…
        window.openGuideDetail = async function(id) {
            showLoading(true);
            try {
                // å…ˆåŠ è½½ç”¨æˆ·ä»Šæ—¥ç‚¹èµåˆ—è¡¨ï¼ˆå¦‚æœå·²ç™»å½•ï¼‰
                if (currentUser && currentUser.token) {
                    await loadTodayLikes();
                }
                
                const response = await fetch(`${API_BASE}/guides/${id}`);
                const result = await response.json();

                if (result.success) {
                    renderGuideDetail(result.data);
                    document.getElementById('guide-modal').classList.add('active');
                    document.body.style.overflow = 'hidden';
                }
            } catch (error) {
                console.error('åŠ è½½æ”»ç•¥è¯¦æƒ…å¤±è´¥:', error);
            }
            showLoading(false);
        };

        // æ¸²æŸ“æ”»ç•¥è¯¦æƒ…
        // æ¸²æŸ“æ”»ç•¥å†…å®¹ï¼ˆæ”¯æŒå¯Œæ–‡æœ¬å’Œçº¯æ–‡æœ¬ï¼‰
        function renderGuideContent(guide) {
            if (guide.contentType === 'richtext') {
                // å¯Œæ–‡æœ¬å†…å®¹éœ€è¦æ¸…ç†XSSé£é™©
                if (typeof DOMPurify !== 'undefined') {
                    return DOMPurify.sanitize(guide.content, {
                        ALLOWED_TAGS: ['p', 'br', 'strong', 'em', 'u', 's', 'h1', 'h2', 'h3', 
                                     'img', 'a', 'ul', 'ol', 'li', 'blockquote', 'code', 'pre',
                                     'span', 'div'],
                        ALLOWED_ATTR: ['href', 'src', 'alt', 'title', 'target', 'class', 'style'],
                        ALLOWED_STYLES: {
                            '*': {
                                'color': [/^#[0-9a-fA-F]{3,6}$/],
                                'background-color': [/^#[0-9a-fA-F]{3,6}$/]
                            }
                        }
                    });
                } else {
                    console.warn('[Security] DOMPurifyæœªåŠ è½½ï¼Œç›´æ¥æ˜¾ç¤ºå¯Œæ–‡æœ¬å¯èƒ½å­˜åœ¨XSSé£é™©');
                    return guide.content;
                }
            } else {
                // çº¯æ–‡æœ¬å†…å®¹ï¼Œä¿æŒæ¢è¡Œ
                return `<pre style="white-space: pre-wrap; word-wrap: break-word; font-family: inherit;">${guide.content}</pre>`;
            }
        }
        
        function renderGuideDetail(guide) {
            console.log('[renderGuideDetail] æ¸²æŸ“æ”»ç•¥è¯¦æƒ…:', guide);
            console.log('[renderGuideDetail] contentImages:', guide.contentImages);
            console.log('[renderGuideDetail] mediaUrls:', guide.mediaUrls);
            
            const container = document.getElementById('guide-detail');
            
            // åª’ä½“ç±»å‹å›¾æ ‡
            const mediaIcon = guide.mediaType === 'video' ? 'fa-video' : guide.mediaType === 'image' ? 'fa-image' : 'fa-file-alt';
            
            // æ£€æŸ¥æ˜¯å¦å·²ç‚¹èµ
            const alreadyLiked = hasLikedToday(guide.id);
            const likeButtonDisabled = alreadyLiked ? 'disabled' : '';
            const likeButtonClass = alreadyLiked ? 'like-btn liked' : 'like-btn';
            const likeButtonText = alreadyLiked ? `å·²ç‚¹èµ (${guide.likes})` : `ç‚¹èµ (${guide.likes})`;
            
            container.innerHTML = `
                <div class="guide-detail-header">
                    <h2>${guide.title}</h2>
                    <div class="guide-detail-meta">
                        <span class="guide-author"><i class="fas fa-user"></i> ${guide.author}</span>
                        <span class="guide-date"><i class="fas fa-calendar"></i> ${new Date(guide.created_at).toLocaleDateString()}</span>
                        <span class="guide-views"><i class="fas fa-eye"></i> ${guide.views} æµè§ˆ</span>
                    </div>
                    <div class="guide-tags">
                        <span class="tag tag-sinner">${guide.sinner}</span>
                        <span class="tag tag-persona">${guide.persona}</span>
                        <span class="tag tag-floor">${guide.floorLevel}å±‚</span>
                        ${guide.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                    </div>
                </div>

                <div class="guide-detail-content">
                    <div class="guide-description ${guide.contentType === 'richtext' ? 'richtext-content' : ''}">
                        ${renderGuideContent(guide)}
                    </div>
                    
                    ${guide.contentImages && guide.contentImages.length > 0 ? `
                        <div class="guide-content-images-section" style="margin-top:24px;">
                            <h3 style="color:var(--lc-gold);font-size:1rem;margin-bottom:16px;display:flex;align-items:center;gap:8px;">
                                <i class="fas fa-images"></i> æ­£æ–‡å›¾ç‰‡
                            </h3>
                            <div class="guide-media-list">
                                ${guide.contentImages.map((img, index) => {
                                    const imageUrl = typeof img === 'string' ? img : img.url;
                                    const isLongImage = typeof img === 'object' && img.isLongImage;
                                    return `<div class="guide-image" style="${isLongImage ? 'max-height:600px;overflow-y:auto;' : ''}">
                                        <img src="${imageUrl}" alt="æ”»ç•¥å›¾ç‰‡ ${index + 1}" 
                                             style="width:100%;${isLongImage ? 'height:auto;' : ''}cursor:pointer;"
                                             onclick="window.openImageModal('${imageUrl}')">
                                    </div>`;
                                }).join('')}
                            </div>
                        </div>
                    ` : ''}

                    ${guide.mediaUrls && guide.mediaUrls.length > 0 ? `
                        <div class="guide-media-section">
                            <h3><i class="fas ${mediaIcon}"></i> æ”»ç•¥å†…å®¹</h3>
                            <div class="guide-media-list">
                                ${guide.mediaUrls.map((url, index) => {
                                    if (guide.mediaType === 'video') {
                                        const embedUrl = convertToEmbedUrl(url);
                                        return `<div class="guide-video" id="video-container-${index}">
                                            <div class="video-placeholder" onclick="loadVideo(this, '${embedUrl}')">
                                                <div class="video-cover">
                                                    <img src="${getVideoCover(url)}" alt="è§†é¢‘å°é¢" onerror="this.style.display='none'">
                                                    <div class="play-overlay">
                                                        <i class="fas fa-play-circle"></i>
                                                        <span>ç‚¹å‡»æ’­æ”¾</span>
                                                    </div>
                                                </div>
                                                <a href="${url}" target="_blank" class="open-new-tab" onclick="event.stopPropagation()">
                                                    <i class="fas fa-external-link-alt"></i> æ–°çª—å£æ‰“å¼€
                                                </a>
                                            </div>
                                        </div>`;
                                    } else {
                                        return `<div class="guide-image">
                                            <img src="${url}" alt="æ”»ç•¥å›¾ç‰‡" onclick="window.openImageModal('${url}')">
                                        </div>`;
                                    }
                                }).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>

                <div class="guide-detail-actions">
                    <button class="${likeButtonClass}" onclick="window.likeGuide(${guide.id})" ${likeButtonDisabled} title="${alreadyLiked ? 'ä»Šå¤©å·²ç‚¹èµ' : 'ç‚¹èµè¿™ä¸ªæ”»ç•¥'}">
                        <i class="fas fa-heart"></i>
                        <span>${likeButtonText}</span>
                    </button>
                    <button class="share-btn" onclick="window.shareGuide(${guide.id})">
                        <i class="fas fa-share-alt"></i>
                        <span>åˆ†äº«</span>
                    </button>
                </div>
            `;
            
            // ä¸ºå¯Œæ–‡æœ¬ä¸­çš„å›¾ç‰‡æ·»åŠ ç‚¹å‡»æ”¾å¤§åŠŸèƒ½
            setTimeout(() => {
                const richTextImages = container.querySelectorAll('.richtext-content img');
                richTextImages.forEach(img => {
                    img.style.cursor = 'pointer';
                    img.onclick = function() {
                        window.openImageModal(this.src);
                    };
                });
            }, 100);
        }

        // è½¬æ¢è§†é¢‘é“¾æ¥ä¸ºåµŒå…¥é“¾æ¥
        function convertToEmbedUrl(url) {
            // Bç«™
            if (url.includes('bilibili.com')) {
                const bvid = url.match(/BV[\w]+/) || url.match(/av\d+/);
                if (bvid) {
                    return `https://player.bilibili.com/player.html?bvid=${bvid[0]}&page=1&autoplay=false&high_quality=1&danmaku=0`;
                }
            }
            // YouTube
            if (url.includes('youtube.com') || url.includes('youtu.be')) {
                const videoId = url.match(/(?:v=|\/)([\w-]{11})/);
                if (videoId) {
                    return `https://www.youtube.com/embed/${videoId[1]}`;
                }
            }
            return url;
        }

        // è·å–è§†é¢‘å°é¢
        function getVideoCover(url) {
            // YouTubeå°é¢
            if (url.includes('youtube.com') || url.includes('youtu.be')) {
                const videoId = url.match(/(?:v=|\/)([\w-]{11})/);
                if (videoId) {
                    return `https://img.youtube.com/vi/${videoId[1]}/mqdefault.jpg`;
                }
            }
            // Bç«™å°é¢éœ€è¦é€šè¿‡APIè·å–ï¼Œè¿™é‡Œè¿”å›ç©ºï¼Œè®©onerrorå¤„ç†æ˜¾ç¤ºé»˜è®¤å ä½ç¬¦
            return '';
        }

        // å»¶è¿ŸåŠ è½½è§†é¢‘
        window.loadVideo = function(element, embedUrl) {
            const container = element.closest('.guide-video');
            
            // æ·»åŠ åŠ è½½æç¤º
            container.innerHTML = `
                <div class="video-loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    æ­£åœ¨åŠ è½½è§†é¢‘...
                </div>
            `;
            
            // åˆ›å»ºiframe
            const iframe = document.createElement('iframe');
            iframe.src = embedUrl;
            iframe.frameBorder = '0';
            iframe.allowFullscreen = true;
            iframe.style.width = '100%';
            iframe.style.height = '100%';
            iframe.style.border = 'none';
            iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
            iframe.setAttribute('sandbox', 'allow-scripts allow-same-origin allow-presentation');
            
            // è¶…æ—¶å¤„ç†
            let timeoutId = setTimeout(() => {
                if (container.querySelector('.video-loading')) {
                    container.innerHTML = `
                        <div class="video-error">
                            <i class="fas fa-exclamation-triangle"></i>
                            è§†é¢‘åŠ è½½è¶…æ—¶ï¼Œè¯·å°è¯•åœ¨åŸç½‘ç«™è§‚çœ‹
                            <br>
                            <a href="${embedUrl.replace('player.html?', 'video/').split('&')[0]}" target="_blank" style="color: #3498db; text-decoration: underline;">
                                åœ¨Bç«™æ‰“å¼€è§†é¢‘
                            </a>
                        </div>
                    `;
                }
            }, 10000); // 10ç§’è¶…æ—¶
            
            // åŠ è½½å®Œæˆåæ›¿æ¢å†…å®¹
            iframe.onload = function() {
                clearTimeout(timeoutId);
                if (container.querySelector('.video-loading')) {
                    container.innerHTML = '';
                    container.appendChild(iframe);
                }
            };
            
            // é”™è¯¯å¤„ç†
            iframe.onerror = function() {
                clearTimeout(timeoutId);
                if (container.querySelector('.video-loading')) {
                    container.innerHTML = `
                        <div class="video-error">
                            <i class="fas fa-exclamation-triangle"></i>
                            è§†é¢‘åŠ è½½å¤±è´¥ï¼Œè¯·å°è¯•åœ¨åŸç½‘ç«™è§‚çœ‹
                            <br>
                            <a href="${embedUrl.replace('player.html?', 'video/').split('&')[0]}" target="_blank" style="color: #3498db; text-decoration: underline;">
                                åœ¨Bç«™æ‰“å¼€è§†é¢‘
                            </a>
                        </div>
                    `;
                }
            };
            
            // å¼€å§‹åŠ è½½
            container.appendChild(iframe);
        };

        // å…³é—­å¼¹çª—
        window.closeGuideModal = function() {
            document.getElementById('guide-modal').classList.remove('active');
            document.body.style.overflow = '';
        };

        // ç”¨æˆ·ä»Šæ—¥ç‚¹èµåˆ—è¡¨
        let todayLikedGuideIds = [];
        
        // è·å–ç”¨æˆ·ä»Šæ—¥ç‚¹èµåˆ—è¡¨
        async function loadTodayLikes() {
            if (!currentUser || !currentUser.token) {
                todayLikedGuideIds = [];
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/guides/my-likes`, {
                    headers: { 'Authorization': `Bearer ${currentUser.token}` }
                });
                const result = await response.json();
                if (result.code === 200 && result.data) {
                    todayLikedGuideIds = result.data.likedGuideIds || [];
                    console.log('[loadTodayLikes] ä»Šæ—¥ç‚¹èµåˆ—è¡¨:', todayLikedGuideIds);
                }
            } catch (error) {
                console.error('è·å–ä»Šæ—¥ç‚¹èµåˆ—è¡¨å¤±è´¥:', error);
            }
        }
        
        // æ£€æŸ¥æ˜¯å¦å·²ç‚¹èµ
        function hasLikedToday(guideId) {
            return todayLikedGuideIds.includes(parseInt(guideId));
        }
        
        // ç‚¹èµæ”»ç•¥
        window.likeGuide = async function(id) {
            // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
            if (!currentUser || !currentUser.token) {
                showMessage('è¯·å…ˆç™»å½•åå†ç‚¹èµ', 'warning');
                openAuthModal();
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»ç‚¹è¿‡èµ
            if (hasLikedToday(id)) {
                showMessage('æ‚¨ä»Šå¤©å·²ç»ç»™è¿™ä¸ªæ”»ç•¥ç‚¹è¿‡èµäº†ï¼Œæ¯å¤©æœ€å¤šç‚¹èµ1æ¬¡', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/guides/${id}/like`, { 
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${currentUser.token}` }
                });
                const result = await response.json();
                
                if (result.success) {
                    // æ›´æ–°ç‚¹èµæ•°æ˜¾ç¤º
                    const btn = document.querySelector('.like-btn span');
                    btn.textContent = `ç‚¹èµ (${result.data.likes})`;
                    btn.closest('.like-btn').classList.add('liked');
                    
                    // æ·»åŠ åˆ°ä»Šæ—¥ç‚¹èµåˆ—è¡¨
                    if (!todayLikedGuideIds.includes(parseInt(id))) {
                        todayLikedGuideIds.push(parseInt(id));
                    }
                    
                    showMessage('ç‚¹èµæˆåŠŸï¼', 'success');
                } else if (result.data?.alreadyLiked) {
                    showMessage('æ‚¨ä»Šå¤©å·²ç»ç»™è¿™ä¸ªæ”»ç•¥ç‚¹è¿‡èµäº†ï¼Œæ¯å¤©æœ€å¤šç‚¹èµ1æ¬¡', 'warning');
                    // æ›´æ–°æœ¬åœ°çŠ¶æ€
                    if (!todayLikedGuideIds.includes(parseInt(id))) {
                        todayLikedGuideIds.push(parseInt(id));
                    }
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    const btn = document.querySelector('.like-btn');
                    if (btn) {
                        btn.classList.add('liked');
                        btn.disabled = true;
                        btn.style.opacity = '0.6';
                        btn.style.cursor = 'not-allowed';
                    }
                } else {
                    showMessage(result.message || 'ç‚¹èµå¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('ç‚¹èµå¤±è´¥:', error);
                showMessage('ç‚¹èµå¤±è´¥: ' + error.message, 'error');
            }
        };

        // åˆ†äº«æ”»ç•¥
        window.shareGuide = function(id) {
            const url = `${window.location.origin}/guides?id=${id}`;
            
            // åˆ›å»ºè‡ªå®šä¹‰åˆ†äº«å¼¹çª—
            const modal = document.createElement('div');
            modal.className = 'custom-modal-overlay';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:9999;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:var(--lc-bg-card);border:1px solid var(--lc-border);border-radius:12px;padding:24px;max-width:420px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.5);">
                    <div style="display:flex;align-items:center;margin-bottom:20px;">
                        <i class="fas fa-share-alt" style="font-size:1.5rem;margin-right:12px;color:var(--lc-gold);"></i>
                        <h3 style="color:var(--lc-gold);margin:0;font-size:1.2rem;">åˆ†äº«æ”»ç•¥</h3>
                    </div>
                    <p style="color:var(--lc-text-secondary);margin:0 0 16px;font-size:0.9rem;">å°†ä»¥ä¸‹é“¾æ¥åˆ†äº«ç»™å¥½å‹ï¼š</p>
                    <div style="background:var(--lc-bg-secondary);border:1px solid var(--lc-border);border-radius:8px;padding:12px;margin-bottom:20px;word-break:break-all;">
                        <code style="color:var(--lc-text);font-size:0.85rem;">${url}</code>
                    </div>
                    <div style="display:flex;gap:10px;">
                        <button id="share-copy-btn" style="flex:1;padding:12px;background:linear-gradient(135deg,var(--lc-gold),#b8942d);border:none;border-radius:8px;color:#000;font-weight:600;cursor:pointer;transition:all 0.2s;">
                            <i class="fas fa-copy"></i> å¤åˆ¶é“¾æ¥
                        </button>
                        <button id="share-close-btn" style="padding:12px 20px;background:transparent;border:1px solid var(--lc-border);border-radius:8px;color:var(--lc-text);cursor:pointer;">
                            å…³é—­
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // å¤åˆ¶æŒ‰é’®äº‹ä»¶
            document.getElementById('share-copy-btn').addEventListener('click', () => {
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(url).then(() => {
                        showMessage('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                        modal.remove();
                    });
                } else {
                    // é™çº§æ–¹æ¡ˆ
                    const input = document.createElement('input');
                    input.value = url;
                    document.body.appendChild(input);
                    input.select();
                    document.execCommand('copy');
                    document.body.removeChild(input);
                    showMessage('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                    modal.remove();
                }
            });
            
            // å…³é—­æŒ‰é’®äº‹ä»¶
            document.getElementById('share-close-btn').addEventListener('click', () => {
                modal.remove();
            });
            
            // ç‚¹å‡»é®ç½©å…³é—­
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        };

        // å›¾ç‰‡å¼¹çª—ï¼ˆæ”¯æŒç¼©æ”¾å’Œæ‹–æ‹½ï¼‰
        window.openImageModal = function(url) {
            // åˆ›å»ºæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.className = 'image-preview-modal';
            
            // åˆ›å»ºå·¥å…·æ 
            const toolbar = document.createElement('div');
            toolbar.className = 'image-preview-toolbar';
            
            // ç¼©æ”¾æ¯”ä¾‹
            let scale = 1;
            let translateX = 0;
            let translateY = 0;
            let isDragging = false;
            let startX = 0;
            let startY = 0;
            
            // åˆ›å»ºå›¾ç‰‡å®¹å™¨
            const container = document.createElement('div');
            container.className = 'image-preview-container';
            
            // åˆ›å»ºå›¾ç‰‡
            const img = document.createElement('img');
            img.src = url;
            img.alt = 'æ”»ç•¥å›¾ç‰‡';
            
            // æ›´æ–°å˜æ¢
            function updateTransform() {
                img.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
            }
            
            // åˆ›å»ºæŒ‰é’®å‡½æ•°
            function createButton(icon, title, onClick) {
                const btn = document.createElement('button');
                btn.innerHTML = `<i class="fas ${icon}"></i>`;
                btn.title = title;
                btn.onclick = (e) => {
                    e.stopPropagation();
                    onClick();
                };
                return btn;
            }
            
            // æ·»åŠ æŒ‰é’®
            toolbar.appendChild(createButton('fa-minus', 'ç¼©å°', () => {
                scale = Math.max(0.2, scale - 0.2);
                updateTransform();
            }));
            
            toolbar.appendChild(createButton('fa-expand', 'é€‚åº”å±å¹•', () => {
                scale = 1;
                translateX = 0;
                translateY = 0;
                img.style.maxWidth = '90vw';
                img.style.maxHeight = '80vh';
                updateTransform();
            }));
            
            toolbar.appendChild(createButton('fa-plus', 'æ”¾å¤§', () => {
                scale = Math.min(5, scale + 0.2);
                img.style.maxWidth = 'none';
                img.style.maxHeight = 'none';
                updateTransform();
            }));
            
            toolbar.appendChild(createButton('fa-search-plus', 'åŸå›¾å°ºå¯¸', () => {
                scale = 1;
                translateX = 0;
                translateY = 0;
                img.style.maxWidth = 'none';
                img.style.maxHeight = 'none';
                updateTransform();
            }));
            
            toolbar.appendChild(createButton('fa-download', 'ä¸‹è½½', () => {
                const link = document.createElement('a');
                link.href = url;
                link.download = url.split('/').pop() || 'image.jpg';
                link.target = '_blank';
                link.click();
            }));
            
            toolbar.appendChild(createButton('fa-times', 'å…³é—­', () => {
                modal.remove();
            }));
            
            // æ·»åŠ é¼ æ ‡æ»šè½®ç¼©æ”¾
            container.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                scale = Math.max(0.2, Math.min(5, scale + delta));
                img.style.maxWidth = 'none';
                img.style.maxHeight = 'none';
                updateTransform();
            });
            
            // æ·»åŠ æ‹–æ‹½åŠŸèƒ½
            container.addEventListener('mousedown', (e) => {
                if (e.target === img || e.target === container) {
                    isDragging = true;
                    startX = e.clientX - translateX;
                    startY = e.clientY - translateY;
                    container.style.cursor = 'grabbing';
                }
            });
            
            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    translateX = e.clientX - startX;
                    translateY = e.clientY - startY;
                    updateTransform();
                }
            });
            
            document.addEventListener('mouseup', () => {
                isDragging = false;
                container.style.cursor = 'grab';
            });
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.addEventListener('click', (e) => {
                if (e.target === modal || e.target === container) {
                    modal.remove();
                }
            });
            
            // ESC é”®å…³é—­
            const keyHandler = (e) => {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', keyHandler);
                }
            };
            document.addEventListener('keydown', keyHandler);
            
            // ç»„è£…
            container.appendChild(img);
            modal.appendChild(toolbar);
            modal.appendChild(container);
            document.body.appendChild(modal);
            
            // é»˜è®¤é€‚åº”å±å¹•
            img.onload = () => {
                const aspectRatio = img.naturalWidth / img.naturalHeight;
                // å¦‚æœæ˜¯é•¿å›¾ï¼ˆé«˜åº¦å¤§äºå®½åº¦çš„2å€ï¼‰ï¼Œé»˜è®¤æ˜¾ç¤ºåŸå›¾å°ºå¯¸
                if (img.naturalHeight > img.naturalWidth * 2) {
                    scale = 1;
                    img.style.maxWidth = 'none';
                    img.style.maxHeight = 'none';
                } else {
                    img.style.maxWidth = '90vw';
                    img.style.maxHeight = '80vh';
                }
                updateTransform();
            };
        };

        // æ˜¾ç¤º/éšè—åŠ è½½
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
        }

        // æ˜¾ç¤ºç©ºçŠ¶æ€
        function showEmptyState(message) {
            const isSearch = currentState.searchQuery;
            document.getElementById('guides-grid').innerHTML = `
                <div class="empty-state">
                    <i class="fas ${isSearch ? 'fa-search' : 'fa-book-open'}" style="font-size:3rem;color:var(--lc-gold);opacity:0.5;"></i>
                    <h3>${isSearch ? 'æœªæ‰¾åˆ°ç›¸å…³æ”»ç•¥' : 'æš‚æ— æ”»ç•¥'}</h3>
                    <p>${message}</p>
                    ${isSearch ? `<button onclick="clearSearch()" style="margin-top:16px;padding:8px 20px;background:var(--lc-gold);border:none;border-radius:6px;color:#1a1a2e;cursor:pointer;font-weight:600;">æ¸…ç©ºæœç´¢</button>` : ''}
                </div>
            `;
        }

        // è‡ªå®šä¹‰æ¶ˆæ¯å¼¹çª—ï¼ˆæ›¿ä»£æµè§ˆå™¨alertï¼‰
        window.showMessage = function(message, type = 'info') {
            const existing = document.getElementById('custom-message-modal');
            if (existing) existing.remove();
            
            const iconMap = {
                success: 'fa-check-circle',
                error: 'fa-times-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };
            const colorMap = {
                success: '#4ade80',
                error: '#ef4444',
                warning: 'var(--lc-gold)',
                info: 'var(--lc-gold)'
            };
            const bgGradient = {
                success: 'linear-gradient(135deg, rgba(74,222,128,0.15), rgba(34,197,94,0.08))',
                error: 'linear-gradient(135deg, rgba(239,68,68,0.15), rgba(185,28,28,0.08))',
                warning: 'linear-gradient(135deg, rgba(201,169,97,0.15), rgba(161,129,57,0.08))',
                info: 'linear-gradient(135deg, rgba(201,169,97,0.15), rgba(161,129,57,0.08))'
            };
            
            const modal = document.createElement('div');
            modal.id = 'custom-message-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.75);
                backdrop-filter: blur(4px);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                animation: fadeIn 0.2s ease;
            `;
            modal.innerHTML = `
                <div style="
                    background: linear-gradient(145deg, #1a1a1a 0%, #0d0d0d 100%);
                    border: 1px solid rgba(201,169,97,0.3);
                    border-radius: 16px;
                    padding: 40px 48px;
                    max-width: 420px;
                    text-align: center;
                    box-shadow: 0 25px 50px -12px rgba(0,0,0,0.8), 0 0 40px rgba(201,169,97,0.1);
                    animation: scaleIn 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
                ">
                    <div style="
                        width: 72px;
                        height: 72px;
                        margin: 0 auto 24px;
                        border-radius: 50%;
                        background: ${bgGradient[type]};
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        border: 2px solid ${colorMap[type]}33;
                    ">
                        <i class="fas ${iconMap[type]}" style="font-size:2rem;color:${colorMap[type]};"></i>
                    </div>
                    <div style="font-size:1rem;color:#e5e5e5;line-height:1.8;white-space:pre-line;margin-bottom:28px;">${message}</div>
                    <button id="message-confirm-btn" style="
                        padding: 14px 48px;
                        background: linear-gradient(135deg, var(--lc-gold) 0%, #b8942d 100%);
                        border: none;
                        border-radius: 10px;
                        color: #000;
                        font-weight: 700;
                        font-size: 1rem;
                        cursor: pointer;
                        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                        box-shadow: 0 4px 15px rgba(201,169,97,0.3);
                    ">
                        ç¡®å®š
                    </button>
                </div>
                <style>
                    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
                    @keyframes scaleIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
                    #message-confirm-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(201,169,97,0.4); }
                </style>
            `;
            modal.addEventListener('click', (e) => {
                if (e.target === modal) window.closeMessageModal();
            });
            document.body.appendChild(modal);
            
            // ç»‘å®šç¡®å®šæŒ‰é’®äº‹ä»¶
            document.getElementById('message-confirm-btn').addEventListener('click', window.closeMessageModal);
        };
        
        window.closeMessageModal = function() {
            const modal = document.getElementById('custom-message-modal');
            if (modal) {
                modal.style.animation = 'fadeIn 0.15s ease reverse';
                setTimeout(() => modal.remove(), 150);
            }
        };

        // ==================== å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½ï¼ˆé€šè¿‡åç«¯ä»£ç†ä¸Šä¼ åˆ°è…¾è®¯äº‘COSï¼Œå®‰å…¨æ— éœ€æš´éœ²SecretKeyï¼‰====================
        // å¤„ç†å°é¢å›¾ç‰‡ä¸Šä¼ 
        window.handleUserCoverUpload = async function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // éªŒè¯æ–‡ä»¶ç±»å‹
            if (!file.type.startsWith('image/')) {
                showMessage('è¯·ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶', 'warning');
                return;
            }
            
            // éªŒè¯æ–‡ä»¶å¤§å° (10MB)
            if (file.size > UPLOAD_CONFIG.maxFileSize) {
                showMessage('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡10MBï¼Œè¯·å‹ç¼©åé‡è¯•', 'warning');
                return;
            }
            
            const uploadArea = document.getElementById('user-cover-upload-area');
            const progressArea = document.getElementById('user-upload-progress');
            const percentEl = document.getElementById('user-upload-percent');
            const progressBar = document.getElementById('user-progress-bar');
            const previewArea = document.getElementById('user-cover-preview');
            const previewImg = document.getElementById('user-preview-img');
            const hiddenInput = document.getElementById('user-guide-cover');
            
            // æ˜¾ç¤ºè¿›åº¦æ¡
            uploadArea.style.display = 'none';
            progressArea.style.display = 'block';
            percentEl.textContent = '0%';
            progressBar.style.width = '0%';
            
            try {
                // é€šè¿‡åç«¯ä»£ç†ä¸Šä¼ åˆ°COSï¼ˆå®‰å…¨æ— éœ€æš´éœ²SecretKeyï¼‰
                const formData = new FormData();
                formData.append('image', file);
                
                // æ¨¡æ‹Ÿè¿›åº¦ï¼ˆå› ä¸ºfetchä¸æ”¯æŒè¿›åº¦å›è°ƒï¼‰
                let progress = 0;
                const progressInterval = setInterval(() => {
                    if (progress < 90) {
                        progress += Math.random() * 10;
                        const percent = Math.min(Math.round(progress), 90);
                        percentEl.textContent = percent + '%';
                        progressBar.style.width = percent + '%';
                    }
                }, 200);
                
                const response = await fetch(`${API_BASE}/upload/image`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${currentUser.token}`
                    },
                    body: formData
                });
                
                clearInterval(progressInterval);
                
                const result = await response.json();
                
                if (result.code === 200 && result.success) {
                    // ä¸Šä¼ æˆåŠŸ
                    percentEl.textContent = '100%';
                    progressBar.style.width = '100%';
                    
                    // æ˜¾ç¤ºé¢„è§ˆ
                    previewImg.src = result.data.url;
                    previewArea.style.display = 'block';
                    progressArea.style.display = 'none';
                    
                    // ä¿å­˜URLåˆ°éšè—å­—æ®µ
                    hiddenInput.value = result.data.url;
                    
                    showMessage('å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼', 'success');
                } else {
                    throw new Error(result.message || 'ä¸Šä¼ å¤±è´¥');
                }
            } catch (error) {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                uploadArea.style.display = 'block';
                progressArea.style.display = 'none';
                showMessage('ä¸Šä¼ å¤±è´¥: ' + (error.message || 'è¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•'), 'error');
            }
        };
        
        // åˆ é™¤å·²ä¸Šä¼ çš„å°é¢å›¾
        window.removeUserCover = function(event) {
            event.stopPropagation();
            
            const uploadArea = document.getElementById('user-cover-upload-area');
            const previewArea = document.getElementById('user-cover-preview');
            const hiddenInput = document.getElementById('user-guide-cover');
            const fileInput = document.getElementById('user-cover-file');
            
            uploadArea.style.display = 'block';
            previewArea.style.display = 'none';
            hiddenInput.value = '';
            fileInput.value = '';
        };

        // ESCå…³é—­å¼¹çª—
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeGuideModal();
                closeUserSubmitModal();
            }
        });

        // ==================== ç”¨æˆ·æŠ•ç¨¿æ”»ç•¥åŠŸèƒ½ ====================
        // ç”Ÿæˆç½ªäººä¸‹æ‹‰é€‰é¡¹
        function generateSinnerOptions() {
            return sinnerData.map(s => {
                const name = s.name.split(' ')[0];
                return `<option value="${name}">${name}</option>`;
            }).join('');
        }

        // ç”Ÿæˆäººæ ¼ä¸‹æ‹‰é€‰é¡¹
        function generatePersonaOptions(sinnerName) {
            const sinner = sinnerData.find(s => s.name.includes(sinnerName));
            if (!sinner) return '<option value="">è¯·å…ˆé€‰æ‹©ç½ªäºº</option>';
            return sinner.personalities.map(p => 
                `<option value="${p.name}">${p.name}</option>`
            ).join('');
        }

        // ç”¨æˆ·æäº¤è®°å½•å­˜å‚¨ï¼ˆä½¿ç”¨ localStorageï¼‰
        function saveUserSubmission(guideData, serverId) {
            const submissions = JSON.parse(localStorage.getItem('user_guide_submissions') || '[]');
            submissions.unshift({
                ...guideData,
                id: serverId, // ä¿å­˜åç«¯è¿”å›çš„ ID
                submittedAt: new Date().toISOString(),
                status: 'pending'
            });
            // åªä¿ç•™æœ€è¿‘50æ¡è®°å½•
            localStorage.setItem('user_guide_submissions', JSON.stringify(submissions.slice(0, 50)));
        }

        // è·å–ç”¨æˆ·æŠ•ç¨¿è®°å½•ï¼ˆä¼˜å…ˆä»æœåŠ¡å™¨è·å–ï¼‰
        async function getUserSubmissions() {
            // å¦‚æœå·²ç™»å½•ï¼Œä»æœåŠ¡å™¨è·å–æœ€æ–°æ•°æ®
            if (currentUser && currentUser.token) {
                try {
                    const response = await fetch(`${API_BASE}/guides/my-submissions`, {
                        headers: { 'Authorization': `Bearer ${currentUser.token}` }
                    });
                    const result = await response.json();
                    
                    if (result.code === 200 && result.data) {
                        // æ•°æ®æ ‡å‡†åŒ–å¤„ç† - ç¡®ä¿å­—æ®µåå…¼å®¹æ€§
                        const normalizedData = result.data.map(item => ({
                            id: item.id,
                            title: item.title,
                            sinner: item.sinner,
                            persona: item.persona,
                            floorLevel: item.floorLevel || item.floor_level || 0,
                            status: item.status,
                            submittedAt: item.submittedAt || item.created_at || item.submitted_at,
                            updatedAt: item.updatedAt || item.updated_at,
                            content: item.content,
                            category: item.category,
                            coverImage: item.coverImage || item.cover_image,
                            author: item.author,
                            mediaType: item.mediaType || item.media_type,
                            mediaUrls: item.mediaUrls || item.media_urls || [],
                            contentImages: item.contentImages || item.content_images || [],
                            contentType: item.contentType || item.content_type,
                            tags: item.tags || [],
                            views: item.views || 0
                        }));
                        
                        // æ›´æ–°æœ¬åœ°ç¼“å­˜
                        localStorage.setItem('user_guide_submissions', JSON.stringify(normalizedData));
                        console.log('[æŠ•ç¨¿è®°å½•] ä»æœåŠ¡å™¨è·å–æˆåŠŸï¼Œå…±', normalizedData.length, 'æ¡');
                        return normalizedData;
                    }
                } catch (error) {
                    console.error('[æŠ•ç¨¿è®°å½•] ä»æœåŠ¡å™¨è·å–å¤±è´¥:', error);
                }
            }
            
            // å›é€€åˆ°æœ¬åœ°ç¼“å­˜ï¼ˆæ¸¸å®¢æ¨¡å¼æˆ–ç½‘ç»œé”™è¯¯ï¼‰
            const localData = localStorage.getItem('user_guide_submissions') || '[]';
            try {
                const parsed = JSON.parse(localData);
                // åŒæ ·è¿›è¡Œæ•°æ®æ ‡å‡†åŒ–
                return parsed.map(item => ({
                    id: item.id,
                    title: item.title,
                    sinner: item.sinner,
                    persona: item.persona,
                    floorLevel: item.floorLevel || item.floor_level || 0,
                    status: item.status,
                    submittedAt: item.submittedAt || item.created_at || item.submitted_at,
                    updatedAt: item.updatedAt || item.updated_at,
                    content: item.content,
                    category: item.category,
                    coverImage: item.coverImage || item.cover_image,
                    author: item.author,
                    mediaType: item.mediaType || item.media_type,
                    mediaUrls: item.mediaUrls || item.media_urls || [],
                    contentImages: item.contentImages || item.content_images || [],
                    contentType: item.contentType || item.content_type,
                    tags: item.tags || [],
                    views: item.views || 0
                }));
            } catch (e) {
                console.error('[æŠ•ç¨¿è®°å½•] è§£ææœ¬åœ°æ•°æ®å¤±è´¥:', e);
                return [];
            }
        }
        
        // æ¸…ç©ºç”¨æˆ·æŠ•ç¨¿è®°å½•
        window.clearUserSubmissions = async function() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æŠ•ç¨¿è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                try {
                    showMessage('æ­£åœ¨åˆ é™¤...', 'info');
                    
                    // è·å–ç”¨æˆ·æŠ•ç¨¿è®°å½•
                    const submissions = await getUserSubmissions();
                    
                    if (!submissions || submissions.length === 0) {
                        showMessage('æ²¡æœ‰æŠ•ç¨¿è®°å½•éœ€è¦æ¸…ç©º', 'info');
                        return;
                    }
                    
                    // åˆ é™¤æœåŠ¡å™¨ä¸Šçš„æ¯ä¸€æ¡æŠ•ç¨¿
                    const deletePromises = submissions.map(async (submission) => {
                        const response = await fetch(`${API_BASE}/guides/user/${submission.id}`, {
                            method: 'DELETE',
                            headers: { 'Authorization': `Bearer ${currentUser.token}` }
                        });
                        
                        if (!response.ok) {
                            throw new Error(`åˆ é™¤æŠ•ç¨¿ ${submission.id} å¤±è´¥`);
                        }
                        
                        return response.json();
                    });
                    
                    await Promise.all(deletePromises);
                    
                    // æ¸…é™¤æœ¬åœ°ç¼“å­˜
                    localStorage.removeItem('user_guide_submissions');
                    
                    showMessage('æ‰€æœ‰æŠ•ç¨¿è®°å½•å·²åˆ é™¤', 'success');
                    await renderMySubmissions();
                    
                } catch (error) {
                    console.error('æ¸…ç©ºæŠ•ç¨¿è®°å½•å¤±è´¥:', error);
                    showMessage('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                }
            }
        }
        
        // æ‰‹åŠ¨åˆ·æ–°æŠ•ç¨¿çŠ¶æ€
        window.refreshMySubmissions = async function() {
            const btn = document.querySelector('button[onclick="refreshMySubmissions()"] i');
            if (btn) btn.classList.add('fa-spin');
            
            try {
                showMessage('æ­£åœ¨åˆ·æ–°...', 'info');
                await renderMySubmissions();
                showMessage('çŠ¶æ€å·²æ›´æ–°', 'success');
            } catch (error) {
                console.error('åˆ·æ–°å¤±è´¥:', error);
                showMessage('åˆ·æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            } finally {
                if (btn) btn.classList.remove('fa-spin');
            }
        }

        // è·å–æœ€è¿‘æäº¤çš„æ’è¡Œæ¦œæ•°æ®ï¼ˆç”¨äºè‡ªåŠ¨å¡«å……æ”»ç•¥è¡¨å•ï¼‰
        function getLastRankingData() {
            try {
                const data = localStorage.getItem('last_ranking_submission');
                if (data) {
                    const parsed = JSON.parse(data);
                    // æ£€æŸ¥æ•°æ®æ˜¯å¦åœ¨24å°æ—¶å†…æäº¤
                    const submitTime = new Date(parsed.submittedAt).getTime();
                    if (Date.now() - submitTime < 24 * 60 * 60 * 1000) {
                        // æ£€æŸ¥æ˜¯å¦å·²ç»ç”¨äºè‡ªåŠ¨å¡«å……è¿‡
                        if (!parsed.autoFilled) {
                            return parsed;
                        }
                    }
                }
            } catch (e) {
                console.error('è·å–æ’è¡Œæ¦œæ•°æ®å¤±è´¥:', e);
            }
            return null;
        }
        
        // æ ‡è®°æ’è¡Œæ¦œæ•°æ®å·²ç”¨äºè‡ªåŠ¨å¡«å……
        function markRankingDataAsAutoFilled() {
            try {
                const data = localStorage.getItem('last_ranking_submission');
                if (data) {
                    const parsed = JSON.parse(data);
                    parsed.autoFilled = true;
                    localStorage.setItem('last_ranking_submission', JSON.stringify(parsed));
                }
            } catch (e) {
                console.error('æ ‡è®°è‡ªåŠ¨å¡«å……å¤±è´¥:', e);
            }
        }

        window.openUserSubmitModal = function() {
            // å¼ºåˆ¶ç™»å½•æ£€æŸ¥
            if (!currentUser) {
                showMessage('è¯·å…ˆç™»å½•åå†æŠ•ç¨¿æ”»ç•¥', 'warning');
                // å»¶è¿Ÿæ‰“å¼€ç™»å½•å¼¹çª—
                setTimeout(() => {
                    openAuthModal();
                }, 500);
                return;
            }
            
            const existing = document.getElementById('user-submit-modal');
            if (existing) existing.remove();
            
            const modal = document.createElement('div');
            modal.id = 'user-submit-modal';
            modal.className = 'custom-modal-overlay';
            modal.innerHTML = `
                <div class="custom-modal" style="min-width:560px;max-width:640px;max-height:85vh;overflow-y:auto;">
                    <div class="custom-modal-header" style="border-bottom:1px solid var(--lc-border);padding-bottom:16px;margin-bottom:20px;">
                        <i class="fas fa-edit" style="font-size:1.5rem;margin-right:12px;color:var(--lc-red);"></i>
                        <div>
                            <h2 class="custom-modal-title">æŠ•ç¨¿å•é€šæ”»ç•¥</h2>
                            <p style="font-size:0.85rem;color:var(--lc-text-muted);margin:4px 0 0;">åˆ†äº«ä½ çš„å•é€šæŠ€å·§ï¼Œå¸®åŠ©æ›´å¤šç©å®¶</p>
                        </div>
                    </div>
                    
                    <!-- æ ‡ç­¾é¡µåˆ‡æ¢ -->
                    <div style="display:flex;gap:0;margin-bottom:20px;border-bottom:2px solid var(--lc-border);">
                        <button id="tab-submit" onclick="switchSubmitTab('submit')" class="submit-tab active" style="flex:1;padding:12px;background:transparent;border:none;border-bottom:3px solid var(--lc-gold);color:var(--lc-gold);font-weight:600;cursor:pointer;transition:all 0.3s;">
                            <i class="fas fa-plus"></i> æäº¤æ”»ç•¥
                        </button>
                        <button id="tab-status" onclick="switchSubmitTab('status')" class="submit-tab" style="flex:1;padding:12px;background:transparent;border:none;border-bottom:3px solid transparent;color:var(--lc-text-muted);font-weight:600;cursor:pointer;transition:all 0.3s;">
                            <i class="fas fa-list"></i> æˆ‘çš„æŠ•ç¨¿
                        </button>
                    </div>
                    
                    <!-- æäº¤è¡¨å•é¢æ¿ -->
                    <div id="panel-submit">
                        <div style="background:rgba(201,169,97,0.1);border-left:3px solid var(--lc-gold);padding:12px 16px;margin-bottom:20px;border-radius:0 6px 6px 0;">
                            <div style="font-size:0.85rem;color:var(--lc-gold);font-weight:600;margin-bottom:4px;">
                                <i class="fas fa-info-circle"></i> æŠ•ç¨¿é¡»çŸ¥
                            </div>
                            <div style="font-size:0.8rem;color:var(--lc-text-secondary);line-height:1.6;">
                                æ”»ç•¥æäº¤åéœ€è¦ç®¡ç†å‘˜å®¡æ ¸é€šè¿‡æ‰ä¼šæ˜¾ç¤ºåœ¨åˆ—è¡¨ä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…
                            </div>
                        </div>
                        
                        <div style="margin-bottom:18px;">
                            <label style="display:block;margin-bottom:8px;color:var(--lc-gold);font-weight:600;font-size:0.9rem;">
                                <i class="fas fa-heading"></i> æ”»ç•¥æ ‡é¢˜ <span style="color:var(--lc-red);">*</span>
                            </label>
                            <input type="text" id="user-guide-title" placeholder="ä¾‹ï¼šæç®±å‰‘å¥‘15å±‚å•é€šæ”»ç•¥" style="width:100%;padding:12px 16px;background:var(--lc-bg-secondary);border:1px solid var(--lc-border);border-radius:8px;color:var(--lc-text);font-size:1rem;box-sizing:border-box;">
                        </div>
                        
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:18px;">
                            <div>
                                <label style="display:block;margin-bottom:8px;color:var(--lc-gold);font-weight:600;font-size:0.9rem;">
                                    <i class="fas fa-user"></i> ç½ªäºº <span style="color:var(--lc-red);">*</span>
                                </label>
                                <select id="user-guide-sinner" onchange="updatePersonaSelect()" style="width:100%;padding:12px 16px;background:var(--lc-bg-secondary);border:1px solid var(--lc-border);border-radius:8px;color:var(--lc-text);box-sizing:border-box;cursor:pointer;">
                                    <option value="">-- è¯·é€‰æ‹©ç½ªäºº --</option>
                                    ${generateSinnerOptions()}
                                </select>
                            </div>
                            <div>
                                <label style="display:block;margin-bottom:8px;color:var(--lc-gold);font-weight:600;font-size:0.9rem;">
                                    <i class="fas fa-masks-theater"></i> äººæ ¼ <span style="color:var(--lc-red);">*</span>
                                </label>
                                <select id="user-guide-persona" style="width:100%;padding:12px 16px;background:var(--lc-bg-secondary);border:1px solid var(--lc-border);border-radius:8px;color:var(--lc-text);box-sizing:border-box;cursor:pointer;">
                                    <option value="">-- è¯·å…ˆé€‰æ‹©ç½ªäºº --</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:18px;">
                            <div>
                                <label style="display:block;margin-bottom:8px;color:var(--lc-gold);font-weight:600;font-size:0.9rem;">
                                    <i class="fas fa-signal"></i> æŒ‘æˆ˜å±‚æ•° <span style="color:var(--lc-red);">*</span>
                                </label>
                                <select id="user-guide-floor" style="width:100%;padding:12px 16px;background:var(--lc-bg-secondary);border:1px solid var(--lc-border);border-radius:8px;color:var(--lc-text);box-sizing:border-box;cursor:pointer;">
                                    <option value="5-2">5-H (å›°éš¾)</option>
                                    <option value="10">10å±‚</option>
                                    <option value="15">15å±‚</option>
                                </select>
                            </div>
                            <div>
                                <label style="display:block;margin-bottom:8px;color:var(--lc-gold);font-weight:600;font-size:0.9rem;">
                                    <i class="fas fa-camera"></i> æ”»ç•¥ç±»å‹
                                </label>
                                <select id="user-guide-media-type" onchange="updateMediaInputByType()" style="width:100%;padding:12px 16px;background:var(--lc-bg-secondary);border:1px solid var(--lc-border);border-radius:8px;color:var(--lc-text);box-sizing:border-box;cursor:pointer;">
                                    <option value="video">è§†é¢‘æ”»ç•¥</option>
                                    <option value="image">å›¾æ–‡æ”»ç•¥</option>
                                    <option value="text">çº¯æ–‡æœ¬</option>
                                    <option value="mixed">æ··åˆç±»å‹</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="margin-bottom:18px;">
                            <label style="display:block;margin-bottom:8px;color:var(--lc-gold);font-weight:600;font-size:0.9rem;">
                                <i class="fas fa-align-left"></i> æ”»ç•¥å†…å®¹ <span style="color:var(--lc-red);">*</span>
                            </label>
                            
                            <!-- å¯Œæ–‡æœ¬ç¼–è¾‘å™¨å®¹å™¨ -->
                            <div class="editor-wrapper">
                                <div id="user-guide-content-editor"></div>
                                <div class="editor-tips">
                                    <i class="fas fa-lightbulb"></i>
                                    <span>æ”¯æŒå¯Œæ–‡æœ¬ç¼–è¾‘ï¼šå›¾ç‰‡å¯ç›´æ¥ç²˜è´´æˆ–ç‚¹å‡»å·¥å…·æ æ’å…¥ï¼Œæ”¯æŒæ ‡é¢˜ã€åˆ—è¡¨ã€å¼•ç”¨ç­‰æ ¼å¼</span>
                                </div>
                            </div>
                            
                            <!-- æ­£æ–‡å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ -->
                            <div id="content-images-section" style="background:rgba(0,0,0,0.1);border-radius:8px;padding:12px;">
                                <label style="display:block;margin-bottom:8px;color:var(--lc-gold);font-size:0.85rem;">
                                    <i class="fas fa-images"></i> æ­£æ–‡å›¾ç‰‡ <span style="color:var(--lc-text-muted);font-weight:400;">(æ”¯æŒé•¿å›¾ã€æ‹–æ‹½æ’åº)</span>
                                </label>
                                
                                <!-- å›¾ç‰‡ç½‘æ ¼ -->
                                <div id="content-images-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:10px;margin-bottom:12px;">
                                </div>
                                
                                <!-- ä¸Šä¼ åŒºåŸŸ -->
                                <div id="content-images-upload-area" 
                                     style="border:2px dashed rgba(201,169,97,0.3);border-radius:10px;padding:16px;text-align:center;background:rgba(0,0,0,0.2);cursor:pointer;transition:all 0.3s;"
                                     onclick="document.getElementById('content-images-file').click()">
                                    <i class="fas fa-cloud-upload-alt" style="font-size:24px;color:rgba(201,169,97,0.5);margin-bottom:6px;display:block;"></i>
                                    <div style="color:var(--lc-text-secondary);font-size:0.8rem;">ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡ä¸Šä¼ </div>
                                    <div style="color:var(--lc-text-muted);font-size:0.7rem;margin-top:4px;">æ”¯æŒå¤šé€‰ã€JPG/PNG/GIFã€æœ€å¤§10MB</div>
                                    <input type="file" id="content-images-file" accept="image/*" multiple style="display:none;">
                                </div>
                                
                                <!-- è¿›åº¦æ¡ -->
                                <div id="content-images-progress" style="display:none;margin-top:10px;">
                                    <div style="display:flex;justify-content:space-between;font-size:0.75rem;margin-bottom:4px;">
                                        <span style="color:var(--lc-gold);">ä¸Šä¼ ä¸­...</span>
                                        <span id="content-images-percent" style="color:var(--lc-text);font-weight:600;">0%</span>
                                    </div>
                                    <div style="height:3px;background:rgba(255,255,255,0.1);border-radius:2px;overflow:hidden;">
                                        <div id="content-images-progress-bar" style="height:100%;width:0%;background:linear-gradient(90deg,var(--lc-gold),#b8942d);transition:width 0.3s;"></div>
                                    </div>
                                    <div id="content-images-upload-status" style="font-size:0.7rem;color:var(--lc-text-muted);margin-top:4px;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom:18px;">
                            <label style="display:block;margin-bottom:8px;color:var(--lc-gold);font-weight:600;font-size:0.9rem;">
                                <i class="fas fa-image"></i> å°é¢å›¾ç‰‡ <span style="color:var(--lc-text-muted);font-weight:400;">(æ¨èæ·»åŠ )</span>
                            </label>
                            
                            <!-- å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ -->
                            <div id="user-cover-upload-area" style="border:2px dashed rgba(201,169,97,0.3);border-radius:12px;padding:24px;text-align:center;background:rgba(0,0,0,0.2);transition:all 0.3s;cursor:pointer;position:relative;" 
                                 ondragover="event.preventDefault();this.style.borderColor='var(--lc-gold)';this.style.background='rgba(201,169,97,0.05)';" 
                                 ondragleave="this.style.borderColor='rgba(201,169,97,0.3)';this.style.background='rgba(0,0,0,0.2)';"
                                 onclick="document.getElementById('user-cover-file').click()">
                                <i class="fas fa-cloud-upload-alt" style="font-size:36px;color:rgba(201,169,97,0.5);margin-bottom:12px;display:block;"></i>
                                <div style="color:var(--lc-text-secondary);font-size:0.9rem;margin-bottom:6px;">ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„ä¸Šä¼ </div>
                                <div style="color:var(--lc-text-muted);font-size:0.75rem;">æ”¯æŒ JPG, PNG, GIF, WEBP æ ¼å¼ï¼Œæœ€å¤§ 10MB</div>
                                <input type="file" id="user-cover-file" accept="image/*" style="display:none;" onchange="handleUserCoverUpload(event)">
                            </div>
                            
                            <!-- ä¸Šä¼ è¿›åº¦ -->
                            <div id="user-upload-progress" style="display:none;margin-top:12px;">
                                <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;">
                                    <span style="font-size:0.8rem;color:var(--lc-gold);">ä¸Šä¼ ä¸­...</span>
                                    <span id="user-upload-percent" style="font-size:0.8rem;color:var(--lc-text);font-weight:600;">0%</span>
                                </div>
                                <div style="height:4px;background:rgba(255,255,255,0.1);border-radius:2px;overflow:hidden;">
                                    <div id="user-progress-bar" style="height:100%;width:0%;background:linear-gradient(90deg,var(--lc-gold),#b8942d);transition:width 0.3s;"></div>
                                </div>
                            </div>
                            
                            <!-- é¢„è§ˆåŒºåŸŸ -->
                            <div id="user-cover-preview" style="display:none;margin-top:12px;position:relative;">
                                <img id="user-preview-img" src="" style="width:100%;max-height:200px;object-fit:cover;border-radius:8px;border:1px solid rgba(201,169,97,0.3);">
                                <button onclick="removeUserCover(event)" style="position:absolute;top:8px;right:8px;width:28px;height:28px;background:rgba(201,79,79,0.9);border:none;border-radius:50%;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s;" title="åˆ é™¤å›¾ç‰‡">
                                    <span style="font-size:12px;">âœ•</span>
                                </button>
                            </div>
                            
                            <input type="hidden" id="user-guide-cover" value="">
                            
                            <div style="background:linear-gradient(135deg,rgba(59,130,246,0.1),rgba(59,130,246,0.05));border:1px solid rgba(59,130,246,0.2);border-radius:8px;padding:10px 12px;font-size:0.8rem;color:var(--lc-text-secondary);line-height:1.5;margin-top:10px;">
                                <i class="fas fa-lightbulb" style="color:#3b82f6;margin-right:6px;"></i>
                                <strong>æç¤ºï¼š</strong>æ·»åŠ å°é¢å›¾ç‰‡èƒ½è®©ä½ çš„æ”»ç•¥æ›´å¸å¼•äººï¼ä¹Ÿå¯ä»¥ç›´æ¥ç²˜è´´å¤–é“¾åœ¨ä¸‹æ–¹
                            </div>
                            
                            <input type="text" id="user-guide-cover-url" placeholder="æˆ–è€…ç²˜è´´å›¾ç‰‡URL (å¯é€‰)" style="width:100%;padding:12px 16px;background:var(--lc-bg-secondary);border:1px solid var(--lc-border);border-radius:8px;color:var(--lc-text);box-sizing:border-box;font-family:inherit;margin-top:10px;">
                        </div>
                        
                        <div id="media-input-container" style="margin-bottom:18px;">
                            <label id="media-input-label" style="display:block;margin-bottom:8px;color:var(--lc-gold);font-weight:600;font-size:0.9rem;">
                                <i class="fas fa-link"></i> è§†é¢‘é“¾æ¥ <span style="color:var(--lc-text-muted);font-weight:400;">(æ¯è¡Œä¸€ä¸ª)</span>
                            </label>
                            <textarea id="user-guide-media-urls" rows="3" placeholder="ç²˜è´´è§†é¢‘é“¾æ¥..." style="width:100%;padding:12px 16px;background:var(--lc-bg-secondary);border:1px solid var(--lc-border);border-radius:8px;color:var(--lc-text);resize:vertical;box-sizing:border-box;font-family:inherit;"></textarea>
                        </div>
                        
                        <div style="margin-bottom:18px;">
                            <label style="display:block;margin-bottom:8px;color:var(--lc-gold);font-weight:600;font-size:0.9rem;">
                                <i class="fas fa-tags"></i> æ ‡ç­¾ <span style="color:var(--lc-text-muted);font-weight:400;">(ç”¨é€—å·åˆ†éš”)</span>
                            </label>
                            <input type="text" id="user-guide-tags" placeholder="æ–°æ‰‹å‹å¥½, ä½é…ç½®, é€Ÿé€š..." style="width:100%;padding:12px 16px;background:var(--lc-bg-secondary);border:1px solid var(--lc-border);border-radius:8px;color:var(--lc-text);box-sizing:border-box;">
                        </div>
                        
                        <div class="custom-modal-footer" style="border-top:1px solid var(--lc-border);padding-top:20px;margin-top:24px;">
                            <button class="custom-modal-btn custom-modal-btn-cancel" onclick="closeUserSubmitModal()">å–æ¶ˆ</button>
                            <button class="custom-modal-btn" onclick="submitUserGuide()" style="background:linear-gradient(135deg,var(--lc-red),#c94f4f);color:#fff;">
                                <i class="fas fa-paper-plane"></i> æäº¤æ”»ç•¥
                            </button>
                        </div>
                    </div>
                    
                    <!-- æˆ‘çš„æŠ•ç¨¿é¢æ¿ -->
                    <div id="panel-status" style="display:none;">
                        <div id="my-submissions-list">
                            <!-- åŠ¨æ€å¡«å…… -->
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // åˆå§‹åŒ–å¯Œæ–‡æœ¬ç¼–è¾‘å™¨
            setTimeout(() => {
                window.guideEditor = new Quill('#user-guide-content-editor', {
                    theme: 'snow',
                    placeholder: 'å¼€å§‹ç¼–å†™ä½ çš„æ”»ç•¥...\n\nğŸ’¡ æç¤ºï¼š\nâ€¢ å¯ä»¥ç›´æ¥ç²˜è´´å›¾ç‰‡\nâ€¢ æ”¯æŒæ ‡é¢˜ã€åˆ—è¡¨ã€å¼•ç”¨ç­‰æ ¼å¼\nâ€¢ ç‚¹å‡»å·¥å…·æ æŒ‰é’®æ’å…¥å›¾ç‰‡å’Œé“¾æ¥',
                    modules: {
                        toolbar: [
                            [{ 'header': [1, 2, 3, false] }],
                            ['bold', 'italic', 'underline', 'strike'],
                            [{ 'color': [] }, { 'background': [] }],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            ['blockquote', 'code-block'],
                            ['link', 'image'],
                            ['clean']
                        ]
                    }
                });
                
                // è‡ªå®šä¹‰å›¾ç‰‡ä¸Šä¼ å¤„ç†
                const toolbar = window.guideEditor.getModule('toolbar');
                toolbar.addHandler('image', handleQuillImageUpload);
                
                console.log('[Quill] å¯Œæ–‡æœ¬ç¼–è¾‘å™¨åˆå§‹åŒ–å®Œæˆ');
            }, 100);
            
            // åˆå§‹åŒ–åª’ä½“è¾“å…¥æ¡†æ˜¾ç¤º
            updateMediaInputByType();
            
            // åˆå§‹åŒ–æ­£æ–‡å›¾ç‰‡ç®¡ç†å™¨
            if (typeof createGuideImageManager !== 'undefined') {
                window.contentImageManager = createGuideImageManager({
                    containerId: 'content-images-grid',
                    uploadAreaId: 'content-images-upload-area',
                    progressAreaId: 'content-images-progress',
                    inputId: 'content-images-file',
                    onChange: (images) => {
                        console.log('[Guide] å›¾ç‰‡åˆ—è¡¨æ›´æ–°:', images);
                    }
                });
                window.contentImageManager.init();
            }
            
            // ä»æ’è¡Œæ¦œæ•°æ®è‡ªåŠ¨å¡«å……è¡¨å•
            const lastRanking = getLastRankingData();
            if (lastRanking) {
                // è‡ªåŠ¨å¡«å……ç½ªäºº
                const sinnerSelect = document.getElementById('user-guide-sinner');
                if (sinnerSelect && lastRanking.sinner) {
                    // å°è¯•åŒ¹é…ç½ªäººåç§°
                    for (let opt of sinnerSelect.options) {
                        if (lastRanking.sinner.includes(opt.value) || opt.value.includes(lastRanking.sinner.split(' ')[0])) {
                            sinnerSelect.value = opt.value;
                            updatePersonaSelect(); // è§¦å‘äººæ ¼æ›´æ–°
                            break;
                        }
                    }
                }
                
                // å»¶è¿Ÿå¡«å……äººæ ¼ï¼ˆç­‰å¾…äººæ ¼åˆ—è¡¨åŠ è½½ï¼‰
                if (lastRanking.persona) {
                    setTimeout(() => {
                        const personaSelect = document.getElementById('user-guide-persona');
                        if (personaSelect) {
                            for (let opt of personaSelect.options) {
                                if (opt.value === lastRanking.persona) {
                                    personaSelect.value = opt.value;
                                    break;
                                }
                            }
                        }
                    }, 100);
                }
                
                // è‡ªåŠ¨å¡«å……æ¥¼å±‚
                if (lastRanking.floorLevel) {
                    const floorSelect = document.getElementById('user-guide-floor');
                    if (floorSelect) {
                        floorSelect.value = lastRanking.floorLevel;
                    }
                }
                
                // è‡ªåŠ¨å¡«å……æˆªå›¾ä½œä¸ºå°é¢
                if (lastRanking.screenshotUrl) {
                    const coverUrlInput = document.getElementById('user-guide-cover-url');
                    if (coverUrlInput) {
                        coverUrlInput.value = lastRanking.screenshotUrl;
                    }
                }
                
                // è‡ªåŠ¨å¡«å……è§†é¢‘é“¾æ¥
                if (lastRanking.videoUrl) {
                    const mediaUrlsInput = document.getElementById('user-guide-media-urls');
                    if (mediaUrlsInput) {
                        mediaUrlsInput.value = lastRanking.videoUrl;
                    }
                    // è®¾ç½®ä¸ºè§†é¢‘æ”»ç•¥ç±»å‹
                    const mediaTypeSelect = document.getElementById('user-guide-media-type');
                    if (mediaTypeSelect) {
                        mediaTypeSelect.value = 'video';
                        updateMediaInputByType();
                    }
                }
                
                // è‡ªåŠ¨ç”Ÿæˆæ ‡é¢˜
                if (lastRanking.sinner && lastRanking.persona && lastRanking.floorLevel) {
                    const titleInput = document.getElementById('user-guide-title');
                    if (titleInput && !titleInput.value) {
                        const sinnerName = lastRanking.sinner.split(' ')[0];
                        titleInput.value = `${sinnerName} ${lastRanking.persona} ${lastRanking.floorLevel}å±‚å•é€šæ”»ç•¥`;
                    }
                }
                
                // æ˜¾ç¤ºæç¤º
                showMessage('å·²ä»æ‚¨æœ€è¿‘çš„æ’è¡Œæ¦œæäº¤ä¸­è‡ªåŠ¨å¡«å……éƒ¨åˆ†ä¿¡æ¯', 'info');
                
                // æ ‡è®°æ•°æ®å·²ç”¨äºè‡ªåŠ¨å¡«å……
                markRankingDataAsAutoFilled();
            }
            
            // ä¿®å¤ï¼šä½¿ç”¨ mousedown/mouseup ç»„åˆåˆ¤æ–­ç‚¹å‡»å¤–éƒ¨ï¼Œé¿å…æ–‡æœ¬é€‰æ‹©æ—¶æ„å¤–å…³é—­
            let isMouseDownOnOverlay = false;
            
            modal.addEventListener('mousedown', (e) => {
                isMouseDownOnOverlay = (e.target === modal);
            });
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal && isMouseDownOnOverlay) {
                    closeUserSubmitModal();
                }
                isMouseDownOnOverlay = false;
            });
        };

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        window.switchSubmitTab = function(tab) {
            document.getElementById('tab-submit').style.borderBottomColor = tab === 'submit' ? 'var(--lc-gold)' : 'transparent';
            document.getElementById('tab-submit').style.color = tab === 'submit' ? 'var(--lc-gold)' : 'var(--lc-text-muted)';
            document.getElementById('tab-status').style.borderBottomColor = tab === 'status' ? 'var(--lc-gold)' : 'transparent';
            document.getElementById('tab-status').style.color = tab === 'status' ? 'var(--lc-gold)' : 'var(--lc-text-muted)';
            
            document.getElementById('panel-submit').style.display = tab === 'submit' ? 'block' : 'none';
            document.getElementById('panel-status').style.display = tab === 'status' ? 'block' : 'none';
            
            if (tab === 'status') {
                renderMySubmissions();
            }
        };

        // æ·»åŠ åŠ è½½åŠ¨ç”»æ ·å¼
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);

        // æ ¹æ®æ”»ç•¥ç±»å‹æ›´æ–°åª’ä½“è¾“å…¥æ¡†
        window.updateMediaInputByType = function() {
            const mediaType = document.getElementById('user-guide-media-type').value;
            const container = document.getElementById('media-input-container');
            const label = document.getElementById('media-input-label');
            const textarea = document.getElementById('user-guide-media-urls');
            const contentImagesSection = document.getElementById('content-images-section');
            
            const config = {
                video: {
                    show: true,
                    label: '<i class="fas fa-link"></i> è§†é¢‘é“¾æ¥ <span style="color:var(--lc-text-muted);font-weight:400;">(æ¯è¡Œä¸€ä¸ª)</span>',
                    placeholder: 'ç²˜è´´Bç«™ã€YouTubeç­‰è§†é¢‘é“¾æ¥...'
                },
                image: {
                    show: true,
                    label: 'ğŸ–¼ï¸ å›¾ç‰‡é“¾æ¥ <span style="color:var(--lc-text-muted);font-weight:400;">(æ¯è¡Œä¸€ä¸ª)</span>',
                    placeholder: 'ç²˜è´´å›¾ç‰‡åœ°å€é“¾æ¥...'
                },
                text: {
                    show: false,
                    label: '',
                    placeholder: ''
                },
                mixed: {
                    show: true,
                    label: '<i class="fas fa-link"></i> è§†é¢‘/å›¾ç‰‡é“¾æ¥ <span style="color:var(--lc-text-muted);font-weight:400;">(æ¯è¡Œä¸€ä¸ª)</span>',
                    placeholder: 'ç²˜è´´è§†é¢‘æˆ–å›¾ç‰‡é“¾æ¥...'
                }
            };
            
            const cfg = config[mediaType];
            if (cfg.show) {
                container.style.display = 'block';
                label.innerHTML = cfg.label;
                textarea.placeholder = cfg.placeholder;
            } else {
                container.style.display = 'none';
                textarea.value = ''; // æ¸…ç©ºè¾“å…¥
            }
            
            // æ§åˆ¶æ­£æ–‡å›¾ç‰‡åŒºåŸŸçš„æ˜¾ç¤º/éšè— - åªåœ¨å›¾æ–‡æ”»ç•¥ç±»å‹æ—¶æ˜¾ç¤º
            if (contentImagesSection) {
                contentImagesSection.style.display = (mediaType === 'image') ? 'block' : 'none';
            }
        };

        // æ¸²æŸ“æˆ‘çš„æŠ•ç¨¿åˆ—è¡¨
        async function renderMySubmissions() {
            const container = document.getElementById('my-submissions-list');
            
            // å…ˆæ˜¾ç¤ºåŠ è½½ä¸­
            container.innerHTML = `
                <div style="text-align:center;padding:40px 20px;color:var(--lc-text-muted);">
                    <div style="font-size:2rem;animation:spin 1s linear infinite;display:inline-block;">âŸ³</div>
                    <p style="margin-top:12px;">æ­£åœ¨åŠ è½½æŠ•ç¨¿è®°å½•...</p>
                </div>
            `;
            
            // ç›´æ¥è·å–æœ€æ–°æ•°æ®ï¼ˆgetUserSubmissionsä¼šè‡ªåŠ¨ä»æœåŠ¡å™¨è·å–ï¼‰
            const submissions = await getUserSubmissions();
            console.log('[renderMySubmissions] è·å–åˆ°æŠ•ç¨¿è®°å½•:', submissions.length, 'æ¡');
            
            if (submissions.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center;padding:40px 20px;color:var(--lc-text-muted);">
                    <i class="fas fa-inbox" style="font-size:2rem;opacity:0.5;"></i><br>
                        <p style="margin-top:16px;">æš‚æ— æŠ•ç¨¿è®°å½•</p>
                        <p style="font-size:0.85rem;margin-top:8px;">æäº¤æ”»ç•¥åå¯åœ¨æ­¤æŸ¥çœ‹å®¡æ ¸çŠ¶æ€</p>
                    </div>
                `;
                return;
            }
            
            // æ·»åŠ æ¸…ç©ºè®°å½•å’Œåˆ·æ–°æŒ‰é’®
            const headerHtml = `
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--lc-border);">
                    <span style="color:var(--lc-text-muted);font-size:0.85rem;">å…± ${submissions.length} æ¡æŠ•ç¨¿è®°å½•</span>
                    <div style="display:flex;gap:8px;">
                        <button onclick="refreshMySubmissions()" style="padding:6px 12px;background:transparent;border:1px solid var(--lc-gold);border-radius:6px;color:var(--lc-gold);font-size:0.8rem;cursor:pointer;display:flex;align-items:center;gap:4px;transition:all 0.2s;">
                            <i class="fas fa-sync-alt"></i> åˆ·æ–°çŠ¶æ€
                        </button>
                        <button onclick="clearUserSubmissions()" style="padding:6px 12px;background:transparent;border:1px solid var(--lc-red);border-radius:6px;color:var(--lc-red);font-size:0.8rem;cursor:pointer;display:flex;align-items:center;gap:4px;transition:all 0.2s;">
                            <i class="fas fa-trash-alt"></i> æ¸…ç©ºè®°å½•
                        </button>
                    </div>
                </div>
            `;
            
            container.innerHTML = headerHtml + submissions.map((s, idx) => {
                const statusMap = {
                    pending: { text: 'å¾…å®¡æ ¸', color: 'var(--lc-gold)', icon: '<i class="fas fa-clock"></i>' },
                    approved: { text: 'å·²é€šè¿‡', color: '#22c55e', icon: '<i class="fas fa-check"></i>' },
                    rejected: { text: 'å·²æ‹’ç»', color: 'var(--lc-red)', icon: '<i class="fas fa-times"></i>' }
                };
                const status = statusMap[s.status] || statusMap.pending;
                
                // æ—¥æœŸæ ¼å¼åŒ– - å¸¦å®¹é”™å¤„ç†
                let dateStr = 'æœªçŸ¥æ—¶é—´';
                if (s.submittedAt) {
                    try {
                        const date = new Date(s.submittedAt);
                        if (!isNaN(date.getTime())) {
                            dateStr = date.toLocaleString('zh-CN');
                        }
                    } catch (e) {
                        console.warn('[æ—¥æœŸè§£æå¤±è´¥]', s.submittedAt);
                    }
                }
                
                // å±‚æ•°æ˜¾ç¤º - å¸¦å®¹é”™å¤„ç†
                const floorLevel = s.floorLevel || 0;
                
                return `
                    <div style="background:var(--lc-bg-secondary);border:1px solid var(--lc-border);border-radius:8px;padding:16px;margin-bottom:12px;">
                        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;">
                            <div style="flex:1;">
                                <h4 style="color:var(--lc-text);font-size:1rem;margin:0 0 6px;">${s.title || 'æ— æ ‡é¢˜'}</h4>
                                <div style="font-size:0.8rem;color:var(--lc-text-muted);">
                                    ${s.sinner || 'æœªçŸ¥ç½ªäºº'} Â· ${s.persona || 'æœªçŸ¥äººæ ¼'} Â· ${floorLevel}å±‚
                                </div>
                            </div>
                            <span style="background:rgba(${status.color === 'var(--lc-gold)' ? '201,169,97' : status.color === '#22c55e' ? '34,197,94' : '201,79,79'},0.15);color:${status.color};padding:4px 10px;border-radius:4px;font-size:0.75rem;font-weight:600;white-space:nowrap;">
                                ${status.icon} ${status.text}
                            </span>
                        </div>
                        <div style="font-size:0.75rem;color:var(--lc-text-muted);">
                            <i class="fas fa-calendar-alt"></i> æäº¤æ—¶é—´: ${dateStr}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // æ›´æ–°äººæ ¼ä¸‹æ‹‰æ¡†
        window.updatePersonaSelect = function() {
            const sinnerSelect = document.getElementById('user-guide-sinner');
            const personaSelect = document.getElementById('user-guide-persona');
            const selectedSinner = sinnerSelect.value;
            
            if (!selectedSinner) {
                personaSelect.innerHTML = '<option value="">-- è¯·å…ˆé€‰æ‹©ç½ªäºº --</option>';
                return;
            }
            
            personaSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©äººæ ¼ --</option>' + generatePersonaOptions(selectedSinner);
        };

        window.closeUserSubmitModal = function() {
            const modal = document.getElementById('user-submit-modal');
            if (modal) modal.remove();
        };
        
        // Quillå›¾ç‰‡ä¸Šä¼ å¤„ç†
        async function handleQuillImageUpload() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            
            input.onchange = async () => {
                const file = input.files[0];
                if (!file) return;
                
                // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶5MBï¼‰
                if (file.size > 5 * 1024 * 1024) {
                    showMessage('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MB', 'warning');
                    return;
                }
                
                // è·å–ç¼–è¾‘å™¨å½“å‰å…‰æ ‡ä½ç½®
                const range = window.guideEditor.getSelection(true);
                
                // æ˜¾ç¤ºä¸Šä¼ ä¸­æç¤º
                window.guideEditor.insertText(range.index, 'ğŸ“¤ ä¸Šä¼ ä¸­...', 'user');
                window.guideEditor.setSelection(range.index + 8);
                
                try {
                    // ä¸Šä¼ å›¾ç‰‡
                    const formData = new FormData();
                    formData.append('image', file);
                    
                    const response = await fetch(`${API_BASE}/upload/image`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (result.code === 200 && result.data.url) {
                        // åˆ é™¤"ä¸Šä¼ ä¸­..."æ–‡å­—
                        window.guideEditor.deleteText(range.index, 8);
                        
                        // æ’å…¥å›¾ç‰‡
                        window.guideEditor.insertEmbed(range.index, 'image', result.data.url);
                        
                        // ç§»åŠ¨å…‰æ ‡åˆ°å›¾ç‰‡åé¢
                        window.guideEditor.setSelection(range.index + 1);
                        
                        console.log('[Quill] å›¾ç‰‡ä¸Šä¼ æˆåŠŸ:', result.data.url);
                    } else {
                        throw new Error(result.message || 'ä¸Šä¼ å¤±è´¥');
                    }
                } catch (error) {
                    console.error('[Quill] å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', error);
                    
                    // åˆ é™¤"ä¸Šä¼ ä¸­..."æ–‡å­—
                    window.guideEditor.deleteText(range.index, 8);
                    
                    showMessage('å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ' + error.message, 'error');
                }
            };
            
            input.click();
        }

        window.submitUserGuide = async function() {
            // å†æ¬¡æ£€æŸ¥ç™»å½•çŠ¶æ€ï¼ˆåŒé‡ä¿éšœï¼‰
            if (!currentUser || !currentUser.token) {
                showMessage('ç™»å½•çŠ¶æ€å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•', 'warning');
                setTimeout(() => openAuthModal(), 500);
                return;
            }
            
            const titleEl = document.getElementById('user-guide-title');
            const sinnerEl = document.getElementById('user-guide-sinner');
            const personaEl = document.getElementById('user-guide-persona');
            const floorEl = document.getElementById('user-guide-floor');
            const mediaTypeEl = document.getElementById('user-guide-media-type');
            const mediaUrlsEl = document.getElementById('user-guide-media-urls');
            const tagsEl = document.getElementById('user-guide-tags');

            const title = titleEl ? titleEl.value.trim() : '';
            const sinner = sinnerEl ? sinnerEl.value : '';
            const persona = personaEl ? personaEl.value : '';
            const floorLevel = floorEl ? floorEl.value : '5-2';
            const mediaType = mediaTypeEl ? mediaTypeEl.value : 'video';
            
            // ä»å¯Œæ–‡æœ¬ç¼–è¾‘å™¨è·å–å†…å®¹
            let content = '';
            let contentType = 'richtext'; // æ ‡è®°ä¸ºå¯Œæ–‡æœ¬ç±»å‹
            
            if (window.guideEditor) {
                // æ£€æŸ¥ç¼–è¾‘å™¨æ˜¯å¦æœ‰å†…å®¹
                const text = window.guideEditor.getText().trim();
                if (text.length === 0) {
                    showMessage('è¯·å¡«å†™æ”»ç•¥å†…å®¹', 'warning');
                    return;
                }
                
                // è·å–HTMLæ ¼å¼çš„å†…å®¹
                content = window.guideEditor.root.innerHTML;
                console.log('[Submit] å¯Œæ–‡æœ¬å†…å®¹é•¿åº¦:', content.length);
            } else {
                showMessage('ç¼–è¾‘å™¨æœªåˆå§‹åŒ–ï¼Œè¯·ç¨åé‡è¯•', 'error');
                return;
            }
            
            const mediaUrlsRaw = mediaUrlsEl ? mediaUrlsEl.value : '';
            const tagsRaw = tagsEl ? tagsEl.value : '';
            
            const mediaUrls = mediaUrlsRaw.split('\n').map(u => u.trim()).filter(u => u);
            const tags = tagsRaw.split(/[,ï¼Œ]/).map(t => t.trim()).filter(t => t);
            
            // è·å–å°é¢å›¾ç‰‡ï¼ˆä¼˜å…ˆä½¿ç”¨ä¸Šä¼ çš„ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥çš„ï¼‰
            const coverEl = document.getElementById('user-guide-cover');
            const coverUrlEl = document.getElementById('user-guide-cover-url');
            const coverUrl = coverEl?.value.trim() || coverUrlEl?.value.trim() || null;
            
            // è·å–æ­£æ–‡å›¾ç‰‡
            const contentImages = window.contentImageManager ? 
                window.contentImageManager.getValidImages() : [];

            // éªŒè¯å¿…å¡«å­—æ®µ
            let errors = [];
            if (!title) errors.push('æ”»ç•¥æ ‡é¢˜');
            if (!sinner) errors.push('ç½ªäºº');
            if (!persona) errors.push('äººæ ¼');
            if (!content) errors.push('æ”»ç•¥å†…å®¹');
            
            if (errors.length > 0) {
                showMessage('è¯·å¡«å†™ä»¥ä¸‹å¿…å¡«é¡¹ï¼š' + errors.join('ã€'), 'warning');
                return;
            }

            showLoading(true);

            const guideData = {
                title,
                sinner,
                persona,
                floorLevel,
                mediaType,
                content,
                contentType, // æ·»åŠ å†…å®¹ç±»å‹æ ‡è¯†
                mediaUrls,
                coverUrl,
                contentImages,
                tags,
                author: currentUser.username, // æ·»åŠ ä½œè€…ä¿¡æ¯
                userToken: currentUser?.token || null
            };

            try {
                const response = await fetch(`${API_BASE}/guides/user-submit`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentUser.token}`
                    },
                    body: JSON.stringify(guideData)
                });

                const result = await response.json();

                showLoading(false);

                if (result.code === 200 || result.success) {
                    // ä¿å­˜åˆ°æœ¬åœ°è®°å½•ï¼ˆä½¿ç”¨åç«¯è¿”å›çš„ IDï¼‰
                    saveUserSubmission(guideData, result.data?.id);
                    showMessage('æ”»ç•¥æäº¤æˆåŠŸï¼\n\nå®¡æ ¸é€šè¿‡åå°†æ˜¾ç¤ºåœ¨åˆ—è¡¨ä¸­ã€‚\næ‚¨å¯ä»¥åœ¨"æˆ‘çš„æŠ•ç¨¿"æ ‡ç­¾é¡µæŸ¥çœ‹å®¡æ ¸çŠ¶æ€ã€‚', 'success');
                    // åˆ‡æ¢åˆ°æˆ‘çš„æŠ•ç¨¿æ ‡ç­¾
                    switchSubmitTab('status');
                } else {
                    showMessage('æäº¤å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                showLoading(false);
                showMessage('æäº¤å¤±è´¥: ' + error.message, 'error');
            }
        };
        
        // ==================== ç”¨æˆ·è®¤è¯ç³»ç»Ÿ ====================
        
        // å½“å‰éªŒè¯ç ID
        let currentCaptchaId = null;
        
        // æ‰“å¼€ç™»å½•/æ³¨å†Œæ¨¡æ€æ¡†
        window.openAuthModal = function() {
            if (currentUser) {
                // å·²ç™»å½•ï¼Œæ˜¾ç¤ºç™»å‡ºç¡®è®¤
                if (confirm(`å½“å‰ç™»å½•: ${currentUser.username}\n\næ˜¯å¦ç™»å‡ºï¼Ÿ`)) {
                    currentUser = null;
                    localStorage.removeItem('limbus_user');
                    updateUserUI();
                    showMessage('å·²ç™»å‡º', 'success');
                }
                return;
            }
            
            const modal = document.createElement('div');
            modal.id = 'auth-modal';
            modal.className = 'custom-modal-overlay';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:10000;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:var(--lc-bg-card);border:1px solid var(--lc-border);border-radius:16px;padding:32px;max-width:420px;width:90%;box-shadow:0 25px 80px rgba(0,0,0,0.6);">
                    <div style="display:flex;align-items:center;margin-bottom:24px;">
                        <i class="fas fa-lock" style="font-size:2rem;margin-right:12px;color:var(--lc-gold);"></i>
                        <h2 style="color:var(--lc-gold);margin:0;font-size:1.4rem;">ç”¨æˆ·ç™»å½•/æ³¨å†Œ</h2>
                    </div>
                    
                    <div style="background:rgba(201,169,97,0.1);border:1px solid rgba(201,169,97,0.3);border-radius:8px;padding:12px;margin-bottom:20px;">
                        <p style="margin:0;color:var(--lc-text-secondary);font-size:0.85rem;line-height:1.5;">
                            <i class="fas fa-exclamation-triangle" style="color:var(--lc-gold);"></i> <strong>é‡è¦æç¤º</strong><br>
                            å¯†ç ä»…ç”¨äºæŸ¥çœ‹æ‚¨çš„æŠ•ç¨¿è®°å½•ï¼Œè¯·åŠ¡å¿…è®°ä½ï¼<br>
                            ç”¨æˆ·ååªèƒ½ä½¿ç”¨è‹±æ–‡å­—æ¯å’Œæ•°å­—ï¼Œå¯†ç éœ€åŒ…å«å­—æ¯å’Œæ•°å­—ç»„åˆã€‚
                        </p>
                    </div>
                    
                    <form id="auth-form" style="margin-bottom:20px;">
                        <div style="margin-bottom:16px;">
                            <label style="display:block;margin-bottom:6px;color:var(--lc-gold);font-size:0.9rem;">ç”¨æˆ·å <span style="color:var(--lc-text-muted);">(3-20ä½è‹±æ–‡æ•°å­—)</span></label>
                            <input type="text" id="auth-username" pattern="[a-zA-Z0-9]+" minlength="3" maxlength="20" required
                                   style="width:100%;padding:12px 14px;background:var(--lc-bg-secondary);border:1px solid var(--lc-border);border-radius:8px;color:var(--lc-text);box-sizing:border-box;font-size:1rem;"
                                   placeholder="ä¾‹å¦‚: Player123">
                            <div id="username-status" style="margin-top:4px;font-size:0.8rem;color:var(--lc-text-muted);"></div>
                        </div>
                        
                        <div style="margin-bottom:16px;">
                            <label style="display:block;margin-bottom:6px;color:var(--lc-gold);font-size:0.9rem;">å¯†ç  <span style="color:var(--lc-text-muted);">(8-20ä½å­—æ¯æ•°å­—ç»„åˆ)</span></label>
                            <input type="password" id="auth-password" minlength="8" maxlength="20" required
                                   style="width:100%;padding:12px 14px;background:var(--lc-bg-secondary);border:1px solid var(--lc-border);border-radius:8px;color:var(--lc-text);box-sizing:border-box;font-size:1rem;"
                                   placeholder="ä¾‹å¦‚: Pass1234">
                        </div>
                        
                        <div style="margin-bottom:20px;">
                            <label style="display:block;margin-bottom:6px;color:var(--lc-gold);font-size:0.9rem;">éªŒè¯ç </label>
                            <div style="display:flex;gap:10px;">
                                <input type="text" id="auth-captcha" required
                                       style="flex:1;padding:12px 14px;background:var(--lc-bg-secondary);border:1px solid var(--lc-border);border-radius:8px;color:var(--lc-text);box-sizing:border-box;font-size:1rem;"
                                       placeholder="è¾“å…¥éªŒè¯ç ">
                                <div id="captcha-svg" style="width:120px;height:40px;background:var(--lc-bg-secondary);border:1px solid var(--lc-border);border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;"
                                     onclick="refreshCaptcha()" title="ç‚¹å‡»åˆ·æ–°">
                                    ç‚¹å‡»è·å–
                                </div>
                            </div>
                        </div>
                        
                        <div style="display:flex;gap:12px;">
                            <button type="submit" id="login-btn" style="flex:1;padding:14px;background:linear-gradient(135deg,var(--lc-gold),#b8942d);border:none;border-radius:8px;color:#000;font-weight:600;cursor:pointer;font-size:1rem;">
                                ç™»å½•
                            </button>
                            <button type="button" id="register-btn" style="flex:1;padding:14px;background:transparent;border:1px solid var(--lc-gold);border-radius:8px;color:var(--lc-gold);font-weight:600;cursor:pointer;font-size:1rem;"
                                    onclick="handleRegister()">
                                æ³¨å†Œ
                            </button>
                        </div>
                    </form>
                    
                    <button onclick="closeAuthModal()" style="width:100%;padding:12px;background:transparent;border:1px solid var(--lc-border);border-radius:8px;color:var(--lc-text-muted);cursor:pointer;">
                        å–æ¶ˆ
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // è·å–éªŒè¯ç 
            refreshCaptcha();
            
            // è¡¨å•æäº¤äº‹ä»¶
            document.getElementById('auth-form').addEventListener('submit', (e) => {
                e.preventDefault();
                handleLogin();
            });
            
            // ç”¨æˆ·åæ£€æŸ¥
            const usernameInput = document.getElementById('auth-username');
            let checkTimeout = null;
            usernameInput.addEventListener('input', () => {
                clearTimeout(checkTimeout);
                const username = usernameInput.value;
                if (username.length >= 3 && /^[a-zA-Z0-9]+$/.test(username)) {
                    checkTimeout = setTimeout(() => checkUsername(username), 500);
                }
            });
        };
        
        // å…³é—­è®¤è¯æ¨¡æ€æ¡†
        window.closeAuthModal = function() {
            const modal = document.getElementById('auth-modal');
            if (modal) modal.remove();
            currentCaptchaId = null;
        };
        
        // åˆ·æ–°éªŒè¯ç 
        window.refreshCaptcha = async function() {
            try {
                const response = await fetch(`${API_BASE}/captcha`);
                const result = await response.json();
                if (result.code === 200) {
                    currentCaptchaId = result.data.captchaId;
                    const captchaImage = result.data.captchaImage || result.data.svg;
                    const captchaSvgEl = document.getElementById('captcha-svg');
                    const captchaImgEl = document.getElementById('captcha-image');
                    
                    if (captchaSvgEl && captchaImage) {
                        captchaSvgEl.innerHTML = captchaImage;
                    }
                    
                    if (captchaImgEl && captchaImage) {
                        captchaImgEl.src = captchaImage;
                    }
                }
            } catch (error) {
                console.error('è·å–éªŒè¯ç å¤±è´¥:', error);
            }
        };
        
        // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å¯ç”¨
        async function checkUsername(username) {
            const statusEl = document.getElementById('username-status');
            try {
                const response = await fetch(`${API_BASE}/auth/check-username/${username}`);
                const result = await response.json();
                if (result.available) {
                    statusEl.innerHTML = '<i class="fas fa-check-circle" style="color:#22c55e;"></i> ç”¨æˆ·åå¯ç”¨';
                    statusEl.style.color = '#22c55e';
                } else {
                    statusEl.textContent = result.message || 'ç”¨æˆ·åå·²è¢«æ³¨å†Œ';
                    statusEl.style.color = 'var(--lc-red)';
                }
            } catch (error) {
                console.error('æ£€æŸ¥ç”¨æˆ·åå¤±è´¥:', error);
            }
        }
        
        // ç™»å½•å¤„ç†
        async function handleLogin() {
            const username = document.getElementById('auth-username').value.trim();
            const password = document.getElementById('auth-password').value;
            const captchaText = document.getElementById('auth-captcha').value.trim();
            
            if (!username || !password || !captchaText) {
                showMessage('è¯·å¡«å†™æ‰€æœ‰å­—æ®µ', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, captchaId: currentCaptchaId, captchaText })
                });
                
                const result = await response.json();
                
                if (result.code === 200 && result.success) {
                    currentUser = {
                        username: result.data.username,
                        token: result.data.token
                    };
                    localStorage.setItem('limbus_user', JSON.stringify(currentUser));
                    updateUserUI();
                    closeAuthModal();
                    showMessage('ç™»å½•æˆåŠŸï¼', 'success');
                } else {
                    showMessage(result.message || 'ç™»å½•å¤±è´¥', 'error');
                    refreshCaptcha();
                }
            } catch (error) {
                console.error('ç™»å½•é”™è¯¯:', error);
                showMessage('ç™»å½•å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ³¨å†Œå¤„ç†
        window.handleRegister = async function() {
            const username = document.getElementById('auth-username').value.trim();
            const password = document.getElementById('auth-password').value;
            const captchaText = document.getElementById('auth-captcha').value.trim();
            
            if (!username || !password || !captchaText) {
                showMessage('è¯·å¡«å†™æ‰€æœ‰å­—æ®µ', 'warning');
                return;
            }
            
            // éªŒè¯ç”¨æˆ·åæ ¼å¼
            if (!/^[a-zA-Z0-9]{3,20}$/.test(username)) {
                showMessage('ç”¨æˆ·ååªèƒ½åŒ…å«3-20ä½è‹±æ–‡å­—æ¯å’Œæ•°å­—', 'warning');
                return;
            }
            
            // éªŒè¯å¯†ç æ ¼å¼ï¼ˆ8-20ä½ï¼ŒåŒ…å«å­—æ¯å’Œæ•°å­—ï¼‰
            if (password.length < 8 || password.length > 20) {
                showMessage('å¯†ç é•¿åº¦å¿…é¡»æ˜¯8-20ä½', 'warning');
                return;
            }
            if (!/[a-zA-Z]/.test(password) || !/\d/.test(password)) {
                showMessage('å¯†ç å¿…é¡»åŒæ—¶åŒ…å«å­—æ¯å’Œæ•°å­—', 'warning');
                return;
            }
            if (!/^[a-zA-Z0-9]+$/.test(password)) {
                showMessage('å¯†ç åªèƒ½åŒ…å«è‹±æ–‡å­—æ¯å’Œæ•°å­—', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, captchaId: currentCaptchaId, captchaText })
                });
                
                const result = await response.json();
                
                if (result.code === 200 && result.success) {
                    showMessage('æ³¨å†ŒæˆåŠŸï¼è¯·ä½¿ç”¨è¯¥è´¦å·ç™»å½•', 'success');
                    // æ¸…ç©ºéªŒè¯ç è¾“å…¥
                    document.getElementById('auth-captcha').value = '';
                    refreshCaptcha();
                } else {
                    showMessage(result.message || 'æ³¨å†Œå¤±è´¥', 'error');
                    refreshCaptcha();
                }
            } catch (error) {
                console.error('æ³¨å†Œé”™è¯¯:', error);
                showMessage('æ³¨å†Œå¤±è´¥: ' + error.message, 'error');
            }
        };
        
        // åˆ·æ–°æŠ•ç¨¿çŠ¶æ€ï¼ˆä¿ç•™æ­¤å‡½æ•°ç”¨äºå‘åå…¼å®¹ï¼Œä½†å®é™…é€»è¾‘å·²ç§»åˆ° getUserSubmissionsï¼‰
        async function refreshSubmissionStatus() {
            // æ­¤å‡½æ•°ç°åœ¨ä¸»è¦ç”¨äºå…¼å®¹æ—§ä»£ç è°ƒç”¨
            // å®é™…æ•°æ®è·å–å·²åœ¨ getUserSubmissions ä¸­å¤„ç†
            console.log('[refreshSubmissionStatus] è°ƒç”¨ï¼ˆæ–°ç‰ˆæœ¬ä½¿ç”¨ getUserSubmissions ç›´æ¥ä»æœåŠ¡å™¨è·å–ï¼‰');
            
            if (!currentUser || !currentUser.token) {
                console.log('[refreshSubmissionStatus] æœªç™»å½•ï¼Œè·³è¿‡åˆ·æ–°');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/guides/my-submissions`, {
                    headers: { 'Authorization': `Bearer ${currentUser.token}` }
                });
                const result = await response.json();
                
                if (result.code === 200 && result.data) {
                    // æ›´æ–°æœ¬åœ°ç¼“å­˜
                    localStorage.setItem('user_guide_submissions', JSON.stringify(result.data));
                    console.log('[refreshSubmissionStatus] å·²æ›´æ–°æœ¬åœ°ç¼“å­˜ï¼Œå…±', result.data.length, 'æ¡è®°å½•');
                }
            } catch (error) {
                console.error('[refreshSubmissionStatus] åˆ·æ–°å¤±è´¥:', error);
            }
        }
    </script>
    
    <!-- Quillå¯Œæ–‡æœ¬ç¼–è¾‘å™¨ -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
</body>
</html>
